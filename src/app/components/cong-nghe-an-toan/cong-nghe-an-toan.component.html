<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="page-header">
        <h2>Công nghệ an toàn</h2>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="bi bi-plus-circle"></i>
          Thêm mới
        </button>
      </div>

      <!-- Bộ lọc -->
      <div class="filter-section">
        <div class="row">
          <div class="col-md-8">
            <div class="form-group">
              <label>Tìm kiếm:</label>
              <input
                type="text"
                class="form-control"
                placeholder="Tìm theo tên công nghệ an toàn..."
                [(ngModel)]="searchKeyword"
                (input)="onSearchChange()"
              />
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label>Trạng thái:</label>
              <select class="form-control" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
                <option value="all">Tất cả</option>
                <option value="false">Đang dùng</option>
                <option value="true">Không dùng nữa</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Bảng công nghệ an toàn -->
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th (click)="changeSort('id')" style="cursor: pointer">
                STT
                <i
                  class="bi ms-1 text-white"
                  [ngClass]="{
                    'bi-caret-up-fill': sortField === 'id' && sortDirection === 'asc',
                    'bi-caret-down-fill': sortField === 'id' && sortDirection === 'desc',
                    'bi-arrow-down-up': sortField !== 'id'
                  }"
                  aria-hidden="true"
                ></i>
              </th>
              <th (click)="changeSort('tenCongNghe')" style="cursor: pointer">
                Tên công nghệ an toàn
                <i
                  class="bi ms-1 text-white"
                  [ngClass]="{
                    'bi-caret-up-fill': sortField === 'tenCongNghe' && sortDirection === 'asc',
                    'bi-caret-down-fill': sortField === 'tenCongNghe' && sortDirection === 'desc',
                    'bi-arrow-down-up': sortField !== 'tenCongNghe'
                  }"
                  aria-hidden="true"
                ></i>
              </th>
              <th>Mô tả</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredItems; trackBy: trackByItemId">
              <td>{{ item.id }}</td>
              <td>{{ item.tenCongNghe }}</td>
              <td>{{ item.moTa || '-' }}</td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(item.trangThai)">
                  {{ item.trangThai ? 'Đang dùng' : 'Không dùng nữa' }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button
                    class="btn btn-outline-info"
                    (click)="openViewModal(item)"
                    title="Xem chi tiết"
                  >
                    <i class="bi bi-eye"></i>
                  </button>
                  <button
                    class="btn btn-outline-warning"
                    (click)="openEditModal(item)"
                    title="Chỉnh sửa"
                  >
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button
                    class="btn btn-outline-danger"
                    (click)="openDeleteModal(item)"
                    title="Xóa"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredItems.length === 0">
              <td colspan="5" class="text-center py-4">
                <div class="text-muted">
                  <i class="bi bi-inbox fs-1 mb-2"></i>
                  <p class="mb-0">Không có dữ liệu</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination controls -->
      <div class="d-flex justify-content-between align-items-center my-3">
        <div>
          <button
            class="btn btn-outline-secondary btn-sm me-2"
            (click)="prevPage()"
            [disabled]="currentPage === 0"
          >
            Trang trước
          </button>
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="nextPage()"
            [disabled]="currentPage + 1 >= totalPages"
          >
            Trang sau
          </button>
        </div>
        <div>
          <span class="me-3">Trang {{ currentPage + 1 }}/{{ totalPages || 1 }}</span>
          <select
            class="form-select form-select-sm d-inline-block"
            style="width: auto"
            [(ngModel)]="pageSize"
            (ngModelChange)="changePageSize($event)"
          >
            <option [ngValue]="5">5</option>
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div
  class="modal fade"
  [class.show]="showModal"
  [style.display]="showModal ? 'block' : 'none'"
  tabindex="-1"
  *ngIf="showModal"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-shield-alt me-2"></i>
          {{ isViewMode ? 'Xem chi tiết' : isEditMode ? 'Chỉnh sửa' : 'Thêm mới' }} Công nghệ an
          toàn
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">
                Tên công nghệ an toàn <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="form.tenCongNghe"
                name="tenCongNghe"
                placeholder="Nhập tên công nghệ an toàn..."
                [readonly]="isViewMode"
                (blur)="markFieldTouched('tenCongNghe')"
                [class.is-invalid]="hasFieldError('tenCongNghe')"
              />
              <div *ngIf="hasFieldError('tenCongNghe')" class="invalid-feedback">
                {{ getFieldError('tenCongNghe') }}
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Mô tả</label>
              <textarea
                class="form-control"
                rows="3"
                [(ngModel)]="form.moTa"
                name="moTa"
                placeholder="Nhập mô tả..."
                [readonly]="isViewMode"
                (blur)="markFieldTouched('moTa')"
                [class.is-invalid]="hasFieldError('moTa')"
              ></textarea>
              <div *ngIf="hasFieldError('moTa')" class="invalid-feedback">
                {{ getFieldError('moTa') }}
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Trạng thái</label>
              <select
                class="form-select"
                [(ngModel)]="form.trangThai"
                name="trangThai"
                [disabled]="isViewMode"
                (change)="markFieldTouched('trangThai')"
                [class.is-invalid]="hasFieldError('trangThai')"
              >
                <option [value]="true">Đang dùng</option>
                <option [value]="false">Không dùng nữa</option>
              </select>
              <div *ngIf="hasFieldError('trangThai')" class="invalid-feedback">
                {{ getFieldError('trangThai') }}
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          {{ isViewMode ? 'Đóng' : 'Hủy' }}
        </button>
        <button *ngIf="!isViewMode" type="button" class="btn btn-primary" (click)="save()">
          <i class="fas fa-save me-2"></i>
          {{ isEditMode ? 'Cập nhật' : 'Lưu' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  [class.show]="showDeleteModal"
  [style.display]="showDeleteModal ? 'block' : 'none'"
  tabindex="-1"
  *ngIf="showDeleteModal"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác nhận xóa</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>
          Bạn có chắc chắn muốn xóa công nghệ an toàn
          <strong>{{ itemToDelete?.tenCongNghe }}</strong> không?
        </p>
        <p class="text-danger">Hành động này không thể hoàn tác!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Hủy</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i class="fas fa-trash me-2"></i>
          Xóa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div
  class="modal-backdrop fade"
  [class.show]="showModal || showDeleteModal"
  *ngIf="showModal || showDeleteModal"
></div>
