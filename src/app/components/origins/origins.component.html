<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Quản lý xuất xứ</h2>
    <button class="btn btn-primary" (click)="openAddModal()">
      <i class="bi bi-plus-circle me-1"></i>Thêm xuất xứ mới
    </button>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">Tìm kiếm:</label>
      <input
        class="form-control"
        placeholder="Tìm theo tên xuất xứ..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
    </div>
    <div class="col-md-3">
      <label class="form-label">Trạng thái:</label>
      <select class="form-select" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
        <option value="all">Tất cả</option>
        <option value="active">Đang dùng</option>
        <option value="inactive">Không dùng nữa</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th (click)="setSort('tenXuatXu')" style="cursor: pointer">
            Tên xuất xứ
            <i
              class="bi ms-1 text-white"
              [ngClass]="{
                'bi-caret-up-fill': sort === 'tenXuatXu,asc',
                'bi-caret-down-fill': sort === 'tenXuatXu,desc',
                'bi-arrow-down-up': !sort.startsWith('tenXuatXu')
              }"
              aria-hidden="true"
            ></i>
          </th>
          <th (click)="setSort('moTa')" style="cursor: pointer">
            Mô tả
            <i
              class="bi ms-1 text-white"
              [ngClass]="{
                'bi-caret-up-fill': sort === 'moTa,asc',
                'bi-caret-down-fill': sort === 'moTa,desc',
                'bi-arrow-down-up': !sort.startsWith('moTa')
              }"
              aria-hidden="true"
            ></i>
          </th>
          <th (click)="setSort('trangThai')" style="cursor: pointer">
            Trạng thái
            <i
              class="bi ms-1 text-white"
              [ngClass]="{
                'bi-caret-up-fill': sort === 'trangThai,asc',
                'bi-caret-down-fill': sort === 'trangThai,desc',
                'bi-arrow-down-up': !sort.startsWith('trangThai')
              }"
              aria-hidden="true"
            ></i>
          </th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let x of display; trackBy: trackById">
          <td>{{ x.tenXuatXu }}</td>
          <td class="text-truncate" style="max-width: 320px">{{ x.moTa || '-' }}</td>
          <td>
            <span class="badge" [class]="x.trangThai ? 'bg-success' : 'bg-secondary'">{{
              x.trangThai ? 'Đang dùng' : 'Không dùng nữa'
            }}</span>
          </td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-info" (click)="viewItem(x)" title="Xem">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning" (click)="openEditModal(x)" title="Sửa">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="delete(x)" title="Xóa">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center my-3">
    <div>
      <button
        class="btn btn-outline-secondary btn-sm me-2"
        (click)="prevPage()"
        [disabled]="page === 0"
      >
        Trang trước
      </button>
      <button
        class="btn btn-outline-secondary btn-sm"
        (click)="nextPage()"
        [disabled]="page + 1 >= totalPages"
      >
        Trang sau
      </button>
    </div>
    <div>
      <span class="me-3">Trang {{ page + 1 }}/{{ totalPages || 1 }}</span>
      <select
        class="form-select form-select-sm d-inline-block"
        style="width: auto"
        [(ngModel)]="size"
        (ngModelChange)="changePageSize($event)"
      >
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
      </select>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <span *ngIf="isViewMode">Xem xuất xứ</span>
            <span *ngIf="isEditMode">Chỉnh sửa xuất xứ</span>
            <span *ngIf="!isViewMode && !isEditMode">Thêm xuất xứ mới</span>
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group mb-3">
              <label>Tên xuất xứ <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="hasFieldError('tenXuatXu')"
                [(ngModel)]="form.tenXuatXu"
                name="tenXuatXu"
                [readonly]="isViewMode"
                (blur)="markFieldTouched('tenXuatXu')"
              />
              <div *ngIf="hasFieldError('tenXuatXu')" class="invalid-feedback">
                {{ getFieldError('tenXuatXu') }}
              </div>
            </div>
            <div class="form-group mb-3">
              <label>Mô tả</label>
              <textarea
                class="form-control"
                [class.is-invalid]="hasFieldError('moTa')"
                rows="3"
                [(ngModel)]="form.moTa"
                name="moTa"
                [readonly]="isViewMode"
                (blur)="markFieldTouched('moTa')"
              ></textarea>
              <div *ngIf="hasFieldError('moTa')" class="invalid-feedback">
                {{ getFieldError('moTa') }}
              </div>
            </div>
            <div class="form-group mb-3">
              <label>Trạng thái</label>
              <select class="form-control" [(ngModel)]="form.trangThai" name="trangThai" [disabled]="isViewMode">
                <option [ngValue]="true">Đang hoạt động</option>
                <option [ngValue]="false">Ngừng</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">
            {{ isViewMode ? 'Đóng' : 'Hủy' }}
          </button>
          <button *ngIf="!isViewMode" class="btn btn-primary" (click)="save()">
            {{ isEditMode ? 'Cập nhật' : 'Thêm mới' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div
    class="modal fade"
    [class.show]="showDeleteModal"
    [style.display]="showDeleteModal ? 'block' : 'none'"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xác nhận xóa</h5>
          <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn xóa <strong>{{ toDelete?.tenXuatXu }}</strong
          >?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Hủy</button>
          <button type="button" class="btn btn-danger" (click)="confirmDelete()">Xóa</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showModal || showDeleteModal" class="modal-backdrop fade show"></div>
</div>
