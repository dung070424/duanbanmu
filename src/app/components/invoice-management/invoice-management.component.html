<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="page-header">
        <h2>Quản lý hóa đơn</h2>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="bi bi-plus-circle"></i>
          Tạo hóa đơn mới
        </button>
      </div>

      <!-- Bộ lọc -->
      <div class="filter-section">
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label>Tìm kiếm:</label>
              <input
                type="text"
                class="form-control"
                placeholder="Tìm theo số hóa đơn, tên khách hàng, SĐT..."
                [(ngModel)]="searchTerm"
                (input)="onSearchInput($event)"
              />
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Trạng thái:</label>
              <select class="form-control" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Thanh toán:</label>
              <select
                class="form-control"
                [(ngModel)]="selectedPaymentStatus"
                (change)="onPaymentStatusChange()"
              >
                <option *ngFor="let option of paymentStatusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Phương thức:</label>
              <select
                class="form-control"
                [(ngModel)]="selectedPaymentMethod"
                (change)="onPaymentMethodChange()"
              >
                <option *ngFor="let option of paymentMethodOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label>&nbsp;</label>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" (click)="filterInvoices()">
                  <i class="bi bi-search"></i>
                  Lọc
                </button>
                <button class="btn btn-outline-secondary" (click)="resetFilters()">
                  <i class="bi bi-arrow-clockwise"></i>
                  Reset
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bảng hóa đơn -->
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th class="sortable" (click)="sort('invoiceNumber')">
                Số hóa đơn
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'invoiceNumber'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'invoiceNumber' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'invoiceNumber' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('customerName')">
                Khách hàng
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'customerName'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'customerName' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'customerName' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('totalAmount')">
                Tổng tiền
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'totalAmount'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'totalAmount' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'totalAmount' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('status')">
                Trạng thái
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'status'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'status' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'status' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('paymentStatus')">
                Thanh toán
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'paymentStatus'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'paymentStatus' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'paymentStatus' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('paymentMethod')">
                Phương thức
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'paymentMethod'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'paymentMethod' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'paymentMethod' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('createdAt')">
                Ngày tạo
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'createdAt'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'createdAt' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'createdAt' && sortDirection === 'desc'"
                ></i>
              </th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of paginatedInvoices">
              <td>
                <span class="invoice-number">{{ invoice.maHoaDon }}</span>
              </td>
              <td>
                <div class="customer-info">
                  <div class="customer-name">{{ invoice.tenKhachHang }}</div>
                  <div class="customer-phone text-muted">{{ invoice.soDienThoaiKhachHang }}</div>
                </div>
              </td>
              <td>
                <span class="total-amount">{{ formatCurrency(invoice.tongTien) }}</span>
              </td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(invoice.trangThai)">
                  {{ getStatusLabel(invoice.trangThai) }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getPaymentStatusClass(invoice.ngayThanhToan ? 'paid' : 'pending')">
                  {{ getPaymentStatusLabel(invoice.ngayThanhToan ? 'paid' : 'pending') }}
                </span>
              </td>
              <td>
                <span class="payment-method">{{
                  getPaymentMethodLabel(invoice.viTriBanHang || 'cash')
                }}</span>
              </td>
              <td>
                <span class="created-date">{{ formatDate(invoice.ngayTao) }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="btn btn-sm btn-outline-info"
                    (click)="openViewModal(invoice)"
                    title="Xem chi tiết"
                  >
                    <i class="bi bi-eye"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-warning"
                    (click)="openEditModal(invoice)"
                    title="Chỉnh sửa"
                  >
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="openDeleteModal(invoice)"
                    title="Xóa"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div
        class="d-flex justify-content-between align-items-center mt-3"
        *ngIf="filteredInvoices.length > 0"
      >
        <div class="d-flex align-items-center">
          <label class="form-label me-2 mb-0">Hiển thị:</label>
          <select
            class="form-select form-select-sm"
            style="width: auto"
            [value]="itemsPerPage"
            (change)="onItemsPerPageChange($event)"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span class="ms-2 text-muted">mục mỗi trang</span>
        </div>

        <div class="pagination-info">
          Hiển thị {{ (currentPage - 1) * itemsPerPage + 1 }} -
          {{ Math.min(currentPage * itemsPerPage, totalItems) }} trong tổng số {{ totalItems }} mục
        </div>

        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-end mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(1)" aria-label="First">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(currentPage - 1)" aria-label="Previous">
                <span aria-hidden="true">&lsaquo;</span>
              </a>
            </li>
            <li
              class="page-item"
              [class.disabled]="currentPage === Math.ceil(totalItems / itemsPerPage)"
            >
              <a class="page-link" (click)="onPageChange(currentPage + 1)" aria-label="Next">
                <span aria-hidden="true">&rsaquo;</span>
              </a>
            </li>
            <li
              class="page-item"
              [class.disabled]="currentPage === Math.ceil(totalItems / itemsPerPage)"
            >
              <a
                class="page-link"
                (click)="onPageChange(Math.ceil(totalItems / itemsPerPage))"
                aria-label="Last"
              >
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Empty state -->
      <div class="text-center py-5" *ngIf="filteredInvoices.length === 0">
        <i class="bi bi-receipt display-1 text-muted"></i>
        <h4 class="text-muted mt-3">Không có hóa đơn nào</h4>
        <p class="text-muted">Chưa có hóa đơn nào phù hợp với bộ lọc hiện tại</p>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="bi bi-plus-circle"></i>
          Tạo hóa đơn đầu tiên
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Invoice Modal -->
<div class="modal fade" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tạo hóa đơn mới</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mã hóa đơn</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.maHoaDon" name="maHoaDon" readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tên khách hàng *</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.tenKhachHang" name="tenKhachHang" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.soDienThoaiKhachHang" name="soDienThoaiKhachHang">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" [(ngModel)]="newInvoice.emailKhachHang" name="emailKhachHang">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tổng tiền</label>
                <input type="number" class="form-control" [(ngModel)]="newInvoice.tongTien" name="tongTien" min="0">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tiền giảm giá</label>
                <input type="number" class="form-control" [(ngModel)]="newInvoice.tienGiamGia" name="tienGiamGia" min="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-control" [(ngModel)]="newInvoice.trangThai" name="trangThai">
                  <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                  <option value="DA_XAC_NHAN">Đã xác nhận</option>
                  <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                  <option value="DA_GIAO_HANG">Đã giao hàng</option>
                  <option value="HUY">Hủy</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Vị trí bán hàng</label>
                <select class="form-control" [(ngModel)]="newInvoice.viTriBanHang" name="viTriBanHang">
                  <option value="Tại quầy">Tại quầy</option>
                  <option value="Online">Online</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" [(ngModel)]="newInvoice.ghiChu" name="ghiChu" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="saveInvoice()">Tạo hóa đơn</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Invoice Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chỉnh sửa hóa đơn</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form *ngIf="editingInvoice">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mã hóa đơn</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.maHoaDon" name="maHoaDon" readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tên khách hàng *</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.tenKhachHang" name="tenKhachHang" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.soDienThoaiKhachHang" name="soDienThoaiKhachHang">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" [(ngModel)]="editingInvoice.emailKhachHang" name="emailKhachHang">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tổng tiền</label>
                <input type="number" class="form-control" [(ngModel)]="editingInvoice.tongTien" name="tongTien" min="0">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tiền giảm giá</label>
                <input type="number" class="form-control" [(ngModel)]="editingInvoice.tienGiamGia" name="tienGiamGia" min="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-control" [(ngModel)]="editingInvoice.trangThai" name="trangThai">
                  <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                  <option value="DA_XAC_NHAN">Đã xác nhận</option>
                  <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                  <option value="DA_GIAO_HANG">Đã giao hàng</option>
                  <option value="HUY">Hủy</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Vị trí bán hàng</label>
                <select class="form-control" [(ngModel)]="editingInvoice.viTriBanHang" name="viTriBanHang">
                  <option value="Tại quầy">Tại quầy</option>
                  <option value="Online">Online</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" [(ngModel)]="editingInvoice.ghiChu" name="ghiChu" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="updateInvoice()">Cập nhật</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác nhận xóa</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa hóa đơn <strong>{{ selectedInvoice?.maHoaDon }}</strong>?</p>
        <p class="text-muted">Hành động này không thể hoàn tác.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-danger" (click)="deleteInvoice()">Xóa</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showAddModal || showEditModal || showViewModal || showDeleteModal" [style.display]="(showAddModal || showEditModal || showViewModal || showDeleteModal) ? 'block' : 'none'"></div>
