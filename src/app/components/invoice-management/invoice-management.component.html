<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="page-header">
        <h2>Quản lý hóa đơn</h2>
        <div>
          <button class="btn btn-primary" (click)="openAddModal()">
            <i class="bi bi-plus-circle"></i>
            Tạo hóa đơn mới
          </button>
        </div>
      </div>


      <!-- Bộ lọcc -->
      <div class="filter-section">
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label>Tìm kiếm:</label>
              <div class="position-relative">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Tìm theo số hóa đơn, tên khách hàng, SĐT..."
                  [(ngModel)]="searchTerm"
                  (input)="onSearchInput($event)"
                  (keydown.enter)="filterInvoices()"
                />
                <div class="position-absolute top-50 end-0 translate-middle-y me-2">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-secondary p-0 border-0 bg-transparent"
                    (click)="clearSearch()"
                    *ngIf="searchTerm && !loadingInvoices"
                    title="Xóa tìm kiếm"
                  >
                    <i class="bi bi-x-circle text-muted"></i>
                  </button>
                  <i class="bi bi-search text-muted" *ngIf="!searchTerm && !loadingInvoices"></i>
                  <span class="spinner-border spinner-border-sm text-primary" *ngIf="loadingInvoices" role="status"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Trạng thái:</label>
              <div class="position-relative">
                <select class="form-control" [(ngModel)]="selectedStatus" (change)="onStatusChange()" [class.border-primary]="selectedStatus !== 'all'">
                  <option *ngFor="let option of statusOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
                <div class="position-absolute top-50 end-0 translate-middle-y me-2" *ngIf="selectedStatus !== 'all'">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-secondary p-0 border-0 bg-transparent"
                    (click)="clearStatusFilter()"
                    title="Xóa lọc trạng thái"
                  >
                    <i class="bi bi-x-circle text-muted"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Thanh toán:</label>
              <div class="position-relative">
                <select
                  class="form-control"
                  [(ngModel)]="selectedPaymentStatus"
                  (change)="onPaymentStatusChange()"
                  [class.border-primary]="selectedPaymentStatus !== 'all'"
                >
                  <option *ngFor="let option of paymentStatusOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
                <div class="position-absolute top-50 end-0 translate-middle-y me-2" *ngIf="selectedPaymentStatus !== 'all'">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-secondary p-0 border-0 bg-transparent"
                    (click)="clearPaymentStatusFilter()"
                    title="Xóa lọc thanh toán"
                  >
                    <i class="bi bi-x-circle text-muted"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Phương thức:</label>
              <div class="position-relative">
                <select
                  class="form-control"
                  [(ngModel)]="selectedPaymentMethod"
                  (change)="onPaymentMethodChange()"
                  [class.border-primary]="selectedPaymentMethod !== 'all'"
                >
                  <option *ngFor="let option of paymentMethodOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
                <div class="position-absolute top-50 end-0 translate-middle-y me-2" *ngIf="selectedPaymentMethod !== 'all'">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-secondary p-0 border-0 bg-transparent"
                    (click)="clearPaymentMethodFilter()"
                    title="Xóa lọc phương thức"
                  >
                    <i class="bi bi-x-circle text-muted"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label>&nbsp;</label>
              <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-secondary" (click)="filterInvoices()" [disabled]="loadingInvoices">
                  <span *ngIf="loadingInvoices" class="spinner-border spinner-border-sm me-1" role="status"></span>
                  <i *ngIf="!loadingInvoices" class="bi bi-search"></i>
                  Lọc
                </button>
                <button class="btn btn-outline-secondary" (click)="resetFilters()" [disabled]="loadingInvoices">
                  <i class="bi bi-arrow-clockwise"></i>
                  Reset
                </button>
                <span class="badge bg-primary" *ngIf="getActiveFilterCount() > 0">
                  {{ getActiveFilterCount() }} bộ lọc
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Results Info -->
      <div class="row mb-3" *ngIf="searchTerm || selectedStatus !== 'all' || selectedPaymentStatus !== 'all' || selectedPaymentMethod !== 'all'">
        <div class="col-12">
          <div class="alert alert-info d-flex align-items-center py-2">
            <i class="bi bi-info-circle me-2"></i>
            <span>
              <strong>{{ totalItems }}</strong> hóa đơn được tìm thấy
              <span *ngIf="searchTerm" class="ms-2">
                với từ khóa: <strong>"{{ searchTerm }}"</strong>
              </span>
              <span *ngIf="selectedStatus !== 'all'" class="ms-2">
                | Trạng thái: <strong>{{ getStatusLabel(selectedStatus) }}</strong>
              </span>
              <span *ngIf="selectedPaymentStatus !== 'all'" class="ms-2">
                | Thanh toán: <strong>{{ getPaymentStatusLabel(selectedPaymentStatus) }}</strong>
              </span>
              <span *ngIf="selectedPaymentMethod !== 'all'" class="ms-2">
                | Phương thức: <strong>{{ getPaymentMethodLabel(selectedPaymentMethod) }}</strong>
              </span>
            </span>
          </div>
        </div>
      </div>

      <!-- Bảng hóa đơn -->
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>STT</th>
              <th class="sortable" (click)="sort('invoiceNumber')">
                Số hóa đơn
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'invoiceNumber'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'invoiceNumber' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'invoiceNumber' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('customerName')">
                Khách hàng
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'customerName'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'customerName' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'customerName' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('totalAmount')">
                Tổng tiền
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'totalAmount'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'totalAmount' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'totalAmount' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('status')">
                Trạng thái
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'status'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'status' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'status' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('paymentStatus')">
                Thanh toán
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'paymentStatus'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'paymentStatus' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'paymentStatus' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('paymentMethod')">
                Phương thức
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'paymentMethod'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'paymentMethod' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'paymentMethod' && sortDirection === 'desc'"
                ></i>
              </th>
              <th class="sortable" (click)="sort('createdAt')">
                Ngày tạo
                <i class="bi bi-arrow-up-down" *ngIf="sortColumn !== 'createdAt'"></i>
                <i
                  class="bi bi-arrow-up-short"
                  *ngIf="sortColumn === 'createdAt' && sortDirection === 'asc'"
                ></i>
                <i
                  class="bi bi-arrow-down-short"
                  *ngIf="sortColumn === 'createdAt' && sortDirection === 'desc'"
                ></i>
              </th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of paginatedInvoices; let i = index">
              <td>
                <span class="badge bg-secondary">{{ (currentPage - 1) * itemsPerPage + i + 1 }}</span>
              </td>
              <td>
                <span class="invoice-number">{{ invoice.maHoaDon }}</span>
              </td>
              <td>
                <div class="customer-info">
                  <div class="customer-name">
                    {{ invoice.tenKhachHang || 'Khách hàng không xác định' }}
                  </div>
                  <div class="customer-phone text-muted">{{ invoice.soDienThoaiKhachHang || 'Chưa có SĐT' }}</div>
                </div>
              </td>
              <td>
                <span class="total-amount">{{ formatCurrency(invoice.tongTien) }}</span>
              </td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(invoice.trangThai)">
                  {{ getStatusLabel(invoice.trangThai) }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getPaymentStatusClass(invoice.ngayThanhToan ? 'paid' : 'pending')">
                  {{ getPaymentStatusLabel(invoice.ngayThanhToan ? 'paid' : 'pending') }}
                </span>
              </td>
              <td>
                <span class="payment-method">{{
                  getPaymentMethodLabel(invoice.viTriBanHang || 'cash')
                }}</span>
              </td>
              <td>
                <span class="created-date">{{ formatDate(invoice.ngayTao) }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="btn btn-sm btn-outline-info"
                    (click)="openViewModal(invoice)"
                    title="Xem chi tiết"
                  >
                    <i class="bi bi-eye"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-warning"
                    (click)="openEditModal(invoice)"
                    title="Chỉnh sửa"
                  >
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="openDeleteModal(invoice)"
                    title="Xóa"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div
        class="d-flex justify-content-between align-items-center mt-3"
        *ngIf="filteredInvoices.length > 0"
      >
        <div class="d-flex align-items-center">
          <label class="form-label me-2 mb-0">Hiển thị:</label>
          <select
            class="form-select form-select-sm"
            style="width: auto"
            [value]="itemsPerPage"
            (change)="onItemsPerPageChange($event)"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span class="ms-2 text-muted">mục mỗi trang</span>
        </div>

        <div class="pagination-info">
          Hiển thị {{ (currentPage - 1) * itemsPerPage + 1 }} -
          {{ Math.min(currentPage * itemsPerPage, totalItems) }} trong tổng số {{ totalItems }} mục
        </div>

        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-end mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(1)" aria-label="First">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(currentPage - 1)" aria-label="Previous">
                <span aria-hidden="true">&lsaquo;</span>
              </a>
            </li>
            <li
              class="page-item"
              [class.disabled]="currentPage === Math.ceil(totalItems / itemsPerPage)"
            >
              <a class="page-link" (click)="onPageChange(currentPage + 1)" aria-label="Next">
                <span aria-hidden="true">&rsaquo;</span>
              </a>
            </li>
            <li
              class="page-item"
              [class.disabled]="currentPage === Math.ceil(totalItems / itemsPerPage)"
            >
              <a
                class="page-link"
                (click)="onPageChange(Math.ceil(totalItems / itemsPerPage))"
                aria-label="Last"
              >
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Empty state -->
      <div class="text-center py-5" *ngIf="filteredInvoices.length === 0">
        <i class="bi bi-receipt display-1 text-muted"></i>
        <h4 class="text-muted mt-3">Không có hóa đơn nào</h4>
        <p class="text-muted">Chưa có hóa đơn nào phù hợp với bộ lọc hiện tại</p>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="bi bi-plus-circle"></i>
          Tạo hóa đơn đầu tiên
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Invoice Modal -->
<div class="modal fade" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" tabindex="-1" role="dialog" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addInvoiceModalLabel">Tạo hóa đơn mới</h5>
        <button type="button" class="btn-close" (click)="closeModals()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mã hóa đơn</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.maHoaDon" name="maHoaDon" readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tên khách hàng *</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.tenKhachHang" name="tenKhachHang" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" [(ngModel)]="newInvoice.soDienThoaiKhachHang" name="soDienThoaiKhachHang">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" [(ngModel)]="newInvoice.emailKhachHang" name="emailKhachHang">
              </div>
            </div>
          </div>
          <!-- Product Selection Section -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <h6>Sản phẩm</h6>
                <button type="button" class="btn btn-outline-primary btn-sm" (click)="openProductModal()">
                  <i class="fas fa-plus"></i> Chọn sản phẩm
                </button>
              </div>

              <!-- Selected Products -->
              <div *ngIf="selectedProducts.length > 0" class="mt-2">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>STT</th>
                        <th>Mã SP</th>
                        <th>Tên sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let product of selectedProducts; let i = index">
                        <td>
                          <span class="badge bg-primary">{{ i + 1 }}</span>
                        </td>
                        <td>
                          <span class="text-muted">{{ product.maSanPham }}</span>
                        </td>
                        <td>
                          <div>
                            <strong>{{ product.tenSanPham }}</strong>
                            <div class="text-muted small">
                              {{ product.danhMuc || 'Chưa phân loại' }} - {{ product.thuongHieu || 'Chưa có' }}
                            </div>
                          </div>
                        </td>
                        <td>
                          <span class="text-success fw-bold">{{ formatCurrency(product.giaBan) }}</span>
                        </td>
                        <td>
                          <input type="number" class="form-control form-control-sm"
                                 [(ngModel)]="product.soLuong"
                                 (input)="onQuantityInputChange(product, $event)"
                                 (ngModelChange)="updateProductQuantity(product, $event)"
                                 min="1"
                                 max="{{ product.soLuongTon }}"
                                 style="width: 80px;">
                          <small class="text-muted">Tồn: {{ product.soLuongTon }}</small>
                        </td>
                        <td>
                          <span class="text-success fw-bold">{{ formatCurrency(product.giaBan * product.soLuong) }}</span>
                        </td>
                        <td>
                          <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeProduct(product)">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Chi tiết tính toán -->
                <div class="mt-3">
                  <div class="alert alert-info">
                    <h6 class="mb-2">
                      <i class="fas fa-calculator me-2"></i>
                      Chi tiết tính toán
                    </h6>
                    <div *ngFor="let product of selectedProducts; let i = index" class="mb-1">
                      <small>
                        {{ i + 1 }}. <strong>{{ product.tenSanPham }}</strong>:
                        {{ formatCurrency(product.giaBan) }} × {{ product.soLuong }} =
                        <span class="text-success fw-bold">{{ formatCurrency(product.giaBan * product.soLuong) }}</span>
                      </small>
                    </div>
                    <hr class="my-2">
                    <div class="fw-bold">
                      Tổng cộng: <span class="text-primary">{{ formatCurrency(newInvoice.tongTien || 0) }}</span>
                    </div>
                    <div *ngIf="discountPercentage > 0" class="text-warning">
                      Giảm giá {{ discountPercentage }}%: -{{ formatCurrency(newInvoice.tienGiamGia || 0) }}
                    </div>
                    <div class="text-success fw-bold">
                      Thành tiền: {{ formatCurrency(newInvoice.thanhTien || 0) }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">
                  Tổng tiền
                  <button type="button" class="btn btn-sm btn-outline-info ms-2"
                          [attr.data-bs-toggle]="'tooltip'"
                          [attr.data-bs-placement]="'top'"
                          [title]="getCalculationDetails()">
                    <i class="fas fa-calculator"></i>
                  </button>
                </label>
                <div class="input-group">
                  <span class="input-group-text">₫</span>
                  <input type="text" class="form-control" [value]="formatCurrency(newInvoice.tongTien || 0)" readonly>
                </div>
                
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Giảm giá (%)</label>
                <input type="number" class="form-control" [(ngModel)]="discountPercentage"
                       (ngModelChange)="onDiscountChange()" name="discountPercentage" min="0" max="100">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Tiền giảm giá</label>
                <input type="number" class="form-control" [(ngModel)]="newInvoice.tienGiamGia" name="tienGiamGia" min="0" readonly>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Thành tiền</label>
                <input type="number" class="form-control" [(ngModel)]="newInvoice.thanhTien" name="thanhTien" min="0" readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-control" [(ngModel)]="newInvoice.trangThai" name="trangThai">
                  <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                  <option value="DA_XAC_NHAN">Đã xác nhận</option>
                  <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                  <option value="DA_GIAO_HANG">Đã giao hàng</option>
                  <option value="HUY">Hủy</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Vị trí bán hàng</label>
                <select class="form-control" [(ngModel)]="newInvoice.viTriBanHang" name="viTriBanHang">
                  <option value="Tại quầy">Tại quầy</option>
                  <option value="Online">Online</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nhân viên</label>
                <select class="form-control" [(ngModel)]="newInvoice.nhanVienId" name="nhanVienId">
                  <option value="1">Nguyễn Văn A</option>
                  <option value="2">Trần Thị B</option>
                  <option value="3">Lê Văn C</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Ngày thanh toán</label>
                <input type="datetime-local" class="form-control" [(ngModel)]="newInvoice.ngayThanhToan" name="ngayThanhToan">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" [(ngModel)]="newInvoice.ghiChu" name="ghiChu" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="saveInvoice()">Tạo hóa đơn</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Invoice Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chỉnh sửa hóa đơn</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form *ngIf="editingInvoice">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mã hóa đơn</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.maHoaDon" name="maHoaDon" readonly>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tên khách hàng *</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.tenKhachHang" name="tenKhachHang" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" [(ngModel)]="editingInvoice.soDienThoaiKhachHang" name="soDienThoaiKhachHang">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" [(ngModel)]="editingInvoice.emailKhachHang" name="emailKhachHang">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tổng tiền</label>
                <div class="input-group">
                  <span class="input-group-text">₫</span>
                  <input type="text" class="form-control" [value]="formatCurrency(editingInvoice.tongTien || 0)" readonly>
                </div>
                <small class="text-muted">Tự động tính từ sản phẩm đã chọn</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tiền giảm giá</label>
                <input type="number" class="form-control" [(ngModel)]="editingInvoice.tienGiamGia" name="tienGiamGia" min="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Thành tiền</label>
                <input type="number" class="form-control" [(ngModel)]="editingInvoice.thanhTien" name="thanhTien" min="0">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-control" [(ngModel)]="editingInvoice.trangThai" name="trangThai">
                  <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                  <option value="DA_XAC_NHAN">Đã xác nhận</option>
                  <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                  <option value="DA_GIAO_HANG">Đã giao hàng</option>
                  <option value="HUY">Hủy</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Vị trí bán hàng</label>
                <select class="form-control" [(ngModel)]="editingInvoice.viTriBanHang" name="viTriBanHang">
                  <option value="Tại quầy">Tại quầy</option>
                  <option value="Online">Online</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nhân viên</label>
                <select class="form-control" [(ngModel)]="editingInvoice.nhanVienId" name="nhanVienId">
                  <option value="1">Nguyễn Văn A</option>
                  <option value="2">Trần Thị B</option>
                  <option value="3">Lê Văn C</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Ngày thanh toán</label>
                <input type="datetime-local" class="form-control" [(ngModel)]="editingInvoice.ngayThanhToan" name="ngayThanhToan">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Ngày tạo</label>
                <input type="datetime-local" class="form-control" [(ngModel)]="editingInvoice.ngayTao" name="ngayTao" readonly>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" [(ngModel)]="editingInvoice.ghiChu" name="ghiChu" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="updateInvoice()">Cập nhật</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác nhận xóa</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa hóa đơn <strong>{{ selectedInvoice?.maHoaDon }}</strong>?</p>
        <p class="text-muted">Hành động này không thể hoàn tác.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button type="button" class="btn btn-danger" (click)="deleteInvoice()">Xóa</button>
      </div>
    </div>
  </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" [class.show]="showProductModal" [style.display]="showProductModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chọn sản phẩm</h5>
        <button type="button" class="btn-close" (click)="closeProductModal()"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>STT</th>
                <th>
                  <input type="checkbox"
                         [checked]="isAllProductsSelected()"
                         [indeterminate]="isSomeProductsSelected()"
                         (change)="toggleSelectAll($event)">
                </th>
                <th>Thao tác</th>
                <th>Mã SP</th>
                <th>Tên sản phẩm</th>
                <th>Giá bán</th>
                <th>Số lượng tồn</th>
                <th>Danh mục</th>
                <th>Thương hiệu</th>
                <th>Mô tả</th>
                <th>Trạng thái</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of availableProducts; let i = index">
                <td>
                  <span class="badge bg-info">{{ i + 1 }}</span>
                </td>
                <td>
                  <input type="checkbox"
                         [checked]="isProductSelected(product)"
                         (change)="toggleProductSelection(product, $event)"
                         [disabled]="!product.trangThai || product.soLuongTon <= 0">
                </td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary" *ngIf="isProductInInvoice(product)">
                      {{ getProductQuantityInInvoice(product) }}
                    </span>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      (click)="addProductToInvoice(product)"
                      [disabled]="!product.trangThai || product.soLuongTon <= 0">
                      <i class="fas fa-plus"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="removeProductFromInvoice(product)"
                      [disabled]="!isProductInInvoice(product)">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>
                </td>
                <td>
                  <span class="text-muted">{{ product.maSanPham }}</span>
                </td>
                <td>
                  <strong>{{ product.tenSanPham }}</strong>
                </td>
                <td>
                  <span class="text-success fw-bold">{{ formatCurrency(product.giaBan) }}</span>
                </td>
                <td>
                  <span class="badge" [class.bg-success]="product.soLuongTon > 10" [class.bg-warning]="product.soLuongTon > 0 && product.soLuongTon <= 10" [class.bg-danger]="product.soLuongTon <= 0">
                    {{ product.soLuongTon }}
                  </span>
                </td>
                <td>
                  <span class="text-muted">{{ product.danhMuc || 'Chưa phân loại' }}</span>
                </td>
                <td>
                  <span class="text-muted">{{ product.thuongHieu || 'Chưa có' }}</span>
                </td>
                <td>
                  <span class="text-muted" [title]="product.moTa">{{ (product.moTa || 'Không có mô tả').substring(0, 50) }}{{ (product.moTa && product.moTa.length > 50) ? '...' : '' }}</span>
                </td>
                <td>
                  <span class="badge" [class.bg-success]="product.trangThai" [class.bg-secondary]="!product.trangThai">
                    {{ product.trangThai ? 'Còn hàng' : 'Hết hàng' }}
                  </span>
                </td>
              </tr>
              
              <!-- Empty state -->
              <tr *ngIf="!loadingProducts && availableProducts.length === 0">
                <td colspan="10" class="text-center py-4">
                  <div class="text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    <p class="mb-0">Không có sản phẩm nào</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto">
          <div class="btn-group" role="group">
            
          </div>
        </div>
        <div class="me-auto">
          <span class="text-muted">
            Đã chọn: <strong>{{ getSelectedProducts().length }}</strong> sản phẩm
            <span *ngIf="selectedProducts.length > 0">
              - Tổng tiền: <strong>{{ formatCurrency(newInvoice.tongTien || 0) }}</strong>
            </span>
          </span>
        </div>
        <button type="button" class="btn btn-secondary" (click)="closeProductModal()">
          <i class="fas fa-times"></i> Hủy
        </button>
        <button type="button" class="btn btn-primary" (click)="confirmProductSelection()" [disabled]="getSelectedProducts().length === 0">
          <i class="fas fa-check"></i> Xác nhận ({{ getSelectedProducts().length }})
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showAddModal || showEditModal || showViewModal || showDeleteModal || showProductModal" [style.display]="(showAddModal || showEditModal || showViewModal || showDeleteModal || showProductModal) ? 'block' : 'none'"></div>
