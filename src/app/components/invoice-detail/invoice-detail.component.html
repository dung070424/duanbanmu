<div class="invoice-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <div class="header-left">
      <h2><i class="fas fa-receipt"></i> Chi tiết hóa đơn #{{ invoice?.maHoaDon }}</h2>
    </div>
    <div class="header-right">
      <button class="btn btn-outline-primary" (click)="printInvoice()">
        <i class="fas fa-print"></i> In hóa đơn
      </button>
      <button class="btn btn-primary" (click)="toggleEditMode()">
        <i class="fas fa-edit"></i> {{ isEditMode ? 'Hủy' : 'Cập nhật' }}
      </button>
    </div>
  </div>


  <!-- Loading State e-->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Đang tải thông tin hóa đơn...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i>
      {{ error }}
    </div>
  </div>

  <!-- Invoice Content -->
  <div *ngIf="invoice && !loading" class="invoice-content">

    <!-- Print Invoice Layout -->
    <div class="print-invoice">
      <!-- Store Header -->
      <div class="invoice-header">
        <div class="store-name">CỬA HÀNG TDK Store</div>
        <div class="store-info">Địa chỉ: Cổng Ong, Tòa nhà FPT Polytechnic, 13 phố Phan Tây Nhạc, phường Xuân Phương, TP Hà Nội | ĐT: 0909 123 456</div>
        <div class="invoice-title">HÓA ĐƠN BÁN HÀNG</div>
      </div>

      <!-- Invoice Information -->
      <div class="invoice-info">
        <div class="info-row">
          <span class="label">Mã hóa đơn:</span>
          <span class="value">{{ invoice.maHoaDon }}</span>
        </div>
        <div class="info-row">
          <span class="label">Ngày tạo:</span>
          <span class="value">{{ formatDate(invoice.ngayTao) }}</span>
        </div>
        <div class="info-row">
          <span class="label">Nhân viên:</span>
          <span class="value">{{ invoice.tenNhanVien || 'Chưa xác định' }}</span>
        </div>
      </div>

      <!-- Customer Information -->
      <div class="customer-info">
        <div class="info-row">
          <span class="label">Khách hàng:</span>
          <span class="value">{{ customer?.tenKhachHang || invoice.tenKhachHang || 'Khách lẻ' }}</span>
        </div>
        <div class="info-row" *ngIf="customer?.soDienThoai || invoice.soDienThoaiKhachHang">
          <span class="label">SĐT:</span>
          <span class="value">{{ customer?.soDienThoai || invoice.soDienThoaiKhachHang }}</span>
        </div>
        <div class="info-row" *ngIf="customer?.email || invoice.emailKhachHang">
          <span class="label">Email:</span>
          <span class="value">{{ customer?.email || invoice.emailKhachHang }}</span>
        </div>
      </div>

      <!-- Product Table -->
      <table class="product-table" *ngIf="invoice.danhSachSanPham && invoice.danhSachSanPham.length > 0">
        <thead>
          <tr>
            <th>STT</th>
            <th>TÊN SẢN PHẨM</th>
            <th>SL</th>
            <th>ĐƠN GIÁ</th>
            <th>THÀNH TIỀN</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of invoice.danhSachSanPham; let i = index">
            <td>{{ i + 1 }}</td>
            <td class="product-name">{{ product.tenSanPham }}</td>
            <td>{{ product.soLuong }}</td>
            <td>{{ formatCurrency(product.donGia) }}</td>
            <td>{{ formatCurrency(product.thanhTien) }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Invoice Summary -->
      <div class="invoice-summary">
        <div class="summary-row">
          <span>TỔNG CỘNG:</span>
          <span>{{ formatCurrency(invoice.tongTien) }} VND</span>
        </div>
        <div class="summary-row" *ngIf="invoice.tienGiamGia && invoice.tienGiamGia > 0">
          <span>Giảm giá:</span>
          <span>{{ formatCurrency(invoice.tienGiamGia) }} VND</span>
        </div>
        <div class="summary-row total-row">
          <span>THANH TOÁN:</span>
          <span>{{ formatCurrency(invoice.thanhTien || invoice.tongTien) }} VND</span>
        </div>
      </div>

      <!-- Payment Information -->
      <div class="payment-info">
        <div class="info-row">
          <span class="label">Hình thức thanh toán:</span>
          <span class="value">{{ invoice.viTriBanHang || 'Tiền mặt' }}</span>
        </div>
        <div class="info-row" *ngIf="invoice.ghiChu">
          <span class="label">Ghi chú:</span>
          <span class="value">{{ invoice.ghiChu }}</span>
        </div>
      </div>

      <!-- Thank You -->
      <div class="thank-you">
        Cảm ơn quý khách đã mua hàng!
      </div>
    </div>

    <!-- Status Progress Bar -->



    
    <div class="status-section">
      <h3>Trạng thái đơn hàng</h3>
      <div class="progress-container">
        <div class="progress-bar-custom" [class.cancelled]="invoice.trangThai === 'HUY'">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
          <div class="progress-steps">
            <div
              *ngFor="let step of statusSteps; let i = index"
              class="progress-step"
              [class.active]="i <= getCurrentStatusIndex()"
              [class.current]="i === getCurrentStatusIndex()"
              [class.cancelled]="invoice.trangThai === 'HUY'"
            >
              <div class="step-icon">
                <i [class]="step.iconClass"></i>
              </div>
              <div class="step-label">{{ step.label }}</div>
            </div>
          </div>
        </div>
        <div *ngIf="invoice.trangThai === 'HUY'" class="cancelled-message">
          <i class="fas fa-times-circle"></i>
          Đơn hàng đã hủy
        </div>
      </div>
    </div>


    <!-- Main Content Grid -->
    <div class="content-grid">

      <!-- Left Column -->
      <div class="left-column">

        <!-- Order Information -->
        <div class="info-card">
          <h4><i class="fas fa-shopping-cart"></i> Thông tin đơn hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Mã hóa đơn:</span>
              <span class="value">{{ invoice.maHoaDon }}</span>
            </div>
            <div class="info-row">
              <span class="label">Ngày tạo:</span>
              <span class="value">{{ formatDate(invoice.ngayTao) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Trạng thái:</span>
              <span class="value" [ngClass]="getStatusClass(invoice.trangThai)">
                {{ getStatusLabel(invoice.trangThai) }}
              </span>
            </div>
            <div class="info-row">
              <span class="label">Ghi chú:</span>
              <span class="value">{{ invoice.ghiChu || 'Không có' }}</span>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="info-card">
          <h4><i class="fas fa-user"></i> Thông tin khách hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Tên khách hàng:</span>
              <span class="value">{{ customer?.tenKhachHang || 'Không có thông tin' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Email:</span>
              <span class="value">{{ customer?.email || 'Không có' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Số điện thoại:</span>
              <span class="value">{{ customer?.soDienThoai || 'Không có' }}</span>
            </div>
            <div class="info-row">
              <span class="label">ID khách hàng:</span>
              <span class="value">{{ invoice.khachHangId || 'Không có' }}</span>
            </div>
          </div>
        </div>


      </div>

      <!-- Middle Column -->
      <div class="middle-column">
        <!-- Payment Information -->
        <div class="info-card">
          <h4><i class="fas fa-credit-card"></i> Thông tin thanh toán</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Trạng thái thanh toán:</span>
              <span class="value" [ngClass]="invoice.ngayThanhToan ? 'text-success' : 'text-warning'">
                {{ invoice.ngayThanhToan ? 'Đã thanh toán' : 'Chờ thanh toán' }}
              </span>
            </div>
            <div class="info-row" *ngIf="invoice.ngayThanhToan">
              <span class="label">Ngày thanh toán:</span>
              <span class="value">{{ formatDate(invoice.ngayThanhToan) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Phương thức:</span>
              <span class="value">{{ invoice.viTriBanHang || 'Tiền mặt' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Tổng tiền:</span>
              <span class="value amount">{{ formatCurrency(invoice.tongTien) }}</span>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="info-card">
          <h4><i class="fas fa-calculator"></i> Tổng kết đơn hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Tổng tiền:</span>
              <span class="value amount">{{ formatCurrency(invoice.tongTien) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Tiền giảm giá:</span>
              <span class="value amount discount">{{ formatCurrency(invoice.tienGiamGia || 0) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Thành tiền:</span>
              <span class="value amount total">{{ formatCurrency(invoice.thanhTien || invoice.tongTien) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Trạng thái:</span>
              <span class="value" [ngClass]="getStatusClass(invoice.trangThai)">
                {{ getStatusLabel(invoice.trangThai) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">

        <!-- Invoice History -->
        <div class="info-card">
          <h4><i class="fas fa-history"></i> Lịch sử hóa đơn</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Ngày tạo:</span>
              <span class="value">{{ formatDate(invoice.ngayTao) }}</span>
            </div>
            <div class="info-row" *ngIf="invoice.ngayThanhToan">
              <span class="label">Ngày thanh toán:</span>
              <span class="value">{{ formatDate(invoice.ngayThanhToan) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Nhân viên xử lý:</span>
              <span class="value">{{ invoice.tenNhanVien || 'Chưa xác định' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Số lượng sản phẩm:</span>
              <span class="value">{{ invoice.soLuongSanPham || 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Product List -->
        <div class="info-card" *ngIf="invoice.danhSachSanPham && invoice.danhSachSanPham.length > 0">
          <h4><i class="fas fa-box"></i> Danh sách sản phẩm</h4>
          <div class="product-list">
            <div *ngFor="let product of invoice.danhSachSanPham" class="product-item">
              <div class="product-info">
                <span class="product-name">{{ product.tenSanPham }}</span>
                <span class="product-quantity">x{{ product.soLuong }}</span>
              </div>
              <div class="product-price">
                {{ formatCurrency(product.thanhTien) }}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Edit Mode -->
    <div *ngIf="isEditMode && editingInvoice" class="edit-section">
      <h3>Cập nhật thông tin hóa đơn</h3>
      <div class="edit-form">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Tên khách hàng:</label>
              <input type="text" class="form-control" [(ngModel)]="editingInvoice.tenKhachHang">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Email khách hàng:</label>
              <input type="email" class="form-control" [(ngModel)]="editingInvoice.emailKhachHang">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Số điện thoại:</label>
              <input type="text" class="form-control" [(ngModel)]="editingInvoice.soDienThoaiKhachHang">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Tổng tiền:</label>
              <input type="number" class="form-control" [(ngModel)]="editingInvoice.tongTien" min="0">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Trạng thái:</label>
              <select class="form-control" [(ngModel)]="editingInvoice.trangThai">
                <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                <option value="DA_XAC_NHAN">Đã xác nhận</option>
                <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                <option value="DA_GIAO_HANG">Đã giao hàng</option>
                <option value="HUY">Hủy</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Ghi chú:</label>
              <textarea class="form-control" [(ngModel)]="editingInvoice.ghiChu" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="edit-actions">
          <button class="btn btn-success" (click)="saveChanges()">
            <i class="fas fa-save"></i> Lưu thay đổi
          </button>
          <button class="btn btn-secondary" (click)="cancelEdit()">
            <i class="fas fa-times"></i> Hủy
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
