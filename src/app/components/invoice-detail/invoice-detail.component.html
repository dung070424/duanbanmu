<div class="invoice-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <div class="header-left">
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Quay lại
      </button>
      <h2>Chi tiết hóa đơn #{{ invoice?.maHoaDon }}</h2>
    </div>
    <div class="header-right">
      <button class="btn btn-outline-primary" (click)="printInvoice()">
        <i class="fas fa-print"></i> In hóa đơn
      </button>
      <button class="btn btn-primary" (click)="toggleEditMode()">
        <i class="fas fa-edit"></i> {{ isEditMode ? 'Hủy' : 'Cập nhậtt' }}
      </button>

    </div>
  </div>


  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Đang tải thông tin hóa đơn...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i>
      {{ error }}
    </div>
  </div>

  <!-- Invoice Content -->
  <div *ngIf="invoice && !loading" class="invoice-content">

    <!-- Status Progress Bar -->
    <div class="status-section">
      <h3>Trạng thái đơn hàng</h3>
      <div class="progress-container">
        <div class="progress-bar-custom" [class.cancelled]="invoice.trangThai === 'HUY'">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
          <div class="progress-steps">
            <div
              *ngFor="let step of statusSteps; let i = index"
              class="progress-step"
              [class.active]="i <= getCurrentStatusIndex()"
              [class.current]="i === getCurrentStatusIndex()"
              [class.cancelled]="invoice.trangThai === 'HUY'"
            >
              <div class="step-icon">
                <i [class]="step.iconClass"></i>
              </div>
              <div class="step-label">{{ step.label }}</div>
            </div>
          </div>
        </div>
        <div *ngIf="invoice.trangThai === 'HUY'" class="cancelled-message">
          <i class="fas fa-times-circle"></i>
          Đơn hàng đã hủy
        </div>
      </div>
    </div>


    <!-- Main Content Grid -->
    <div class="content-grid">

      <!-- Left Column -->
      <div class="left-column">

        <!-- Order Information -->
        <div class="info-card">
          <h4><i class="fas fa-shopping-cart"></i> Thông tin đơn hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Mã hóa đơn:</span>
              <span class="value">{{ invoice.maHoaDon }}</span>
            </div>
            <div class="info-row">
              <span class="label">Ngày tạo:</span>
              <span class="value">{{ formatDate(invoice.ngayTao) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Trạng thái:</span>
              <span class="value" [ngClass]="getStatusClass(invoice.trangThai)">
                {{ getStatusLabel(invoice.trangThai) }}
              </span>
            </div>
            <div class="info-row">
              <span class="label">Ghi chú:</span>
              <span class="value">{{ invoice.ghiChu || 'Không có' }}</span>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="info-card">
          <h4><i class="fas fa-user"></i> Thông tin khách hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Tên khách hàng:</span>
              <span class="value">{{ customer?.tenKhachHang || 'Không có thông tin' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Email:</span>
              <span class="value">{{ customer?.email || 'Không có' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Số điện thoại:</span>
              <span class="value">{{ customer?.soDienThoai || 'Không có' }}</span>
            </div>
            <div class="info-row">
              <span class="label">ID khách hàng:</span>
              <span class="value">{{ invoice.khachHangId || 'Không có' }}</span>
            </div>
          </div>
        </div>

        <!-- Payment History -->
        <div class="info-card">
          <h4><i class="fas fa-credit-card"></i> Lịch sử thanh toán</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Trạng thái thanh toán:</span>
              <span class="value" [ngClass]="invoice.ngayThanhToan ? 'text-success' : 'text-warning'">
                {{ invoice.ngayThanhToan ? 'Đã thanh toán' : 'Chờ thanh toán' }}
              </span>
            </div>
            <div class="info-row" *ngIf="invoice.ngayThanhToan">
              <span class="label">Ngày thanh toán:</span>
              <span class="value">{{ formatDate(invoice.ngayThanhToan) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Phương thức:</span>
              <span class="value">{{ invoice.viTriBanHang || 'Tiền mặt' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Tổng tiền:</span>
              <span class="value amount">{{ formatCurrency(invoice.tongTien) }}</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="right-column">

        <!-- Invoice History -->
        <div class="info-card">
          <h4><i class="fas fa-history"></i> Lịch sử hóa đơn</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Ngày tạo:</span>
              <span class="value">{{ formatDate(invoice.ngayTao) }}</span>
            </div>
            <div class="info-row" *ngIf="invoice.ngayThanhToan">
              <span class="label">Ngày thanh toán:</span>
              <span class="value">{{ formatDate(invoice.ngayThanhToan) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Nhân viên xử lý:</span>
              <span class="value">{{ invoice.tenNhanVien || 'Chưa xác định' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Số lượng sản phẩm:</span>
              <span class="value">{{ invoice.soLuongSanPham || 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="info-card">
          <h4><i class="fas fa-calculator"></i> Tổng kết đơn hàng</h4>
          <div class="info-table">
            <div class="info-row">
              <span class="label">Tổng tiền:</span>
              <span class="value amount">{{ formatCurrency(invoice.tongTien) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Tiền giảm giá:</span>
              <span class="value amount discount">{{ formatCurrency(invoice.tienGiamGia || 0) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Thành tiền:</span>
              <span class="value amount total">{{ formatCurrency(invoice.thanhTien || invoice.tongTien) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Trạng thái:</span>
              <span class="value" [ngClass]="getStatusClass(invoice.trangThai)">
                {{ getStatusLabel(invoice.trangThai) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Product List -->
        <div class="info-card" *ngIf="invoice.danhSachSanPham && invoice.danhSachSanPham.length > 0">
          <h4><i class="fas fa-box"></i> Danh sách sản phẩm</h4>
          <div class="product-list">
            <div *ngFor="let product of invoice.danhSachSanPham" class="product-item">
              <div class="product-info">
                <span class="product-name">{{ product.tenSanPham }}</span>
                <span class="product-quantity">x{{ product.soLuong }}</span>
              </div>
              <div class="product-price">
                {{ formatCurrency(product.thanhTien) }}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Edit Mode -->
    <div *ngIf="isEditMode && editingInvoice" class="edit-section">
      <h3>Cập nhật thông tin hóa đơn</h3>
      <div class="edit-form">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Tên khách hàng:</label>
              <input type="text" class="form-control" [(ngModel)]="editingInvoice.tenKhachHang">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Email khách hàng:</label>
              <input type="email" class="form-control" [(ngModel)]="editingInvoice.emailKhachHang">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Số điện thoại:</label>
              <input type="text" class="form-control" [(ngModel)]="editingInvoice.soDienThoaiKhachHang">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Tổng tiền:</label>
              <input type="number" class="form-control" [(ngModel)]="editingInvoice.tongTien" min="0">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Trạng thái:</label>
              <select class="form-control" [(ngModel)]="editingInvoice.trangThai">
                <option value="CHO_XAC_NHAN">Chờ xác nhận</option>
                <option value="DA_XAC_NHAN">Đã xác nhận</option>
                <option value="DANG_GIAO_HANG">Đang giao hàng</option>
                <option value="DA_GIAO_HANG">Đã giao hàng</option>
                <option value="HUY">Hủy</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Ghi chú:</label>
              <textarea class="form-control" [(ngModel)]="editingInvoice.ghiChu" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="edit-actions">
          <button class="btn btn-success" (click)="saveChanges()">
            <i class="fas fa-save"></i> Lưu thay đổi
          </button>
          <button class="btn btn-secondary" (click)="cancelEdit()">
            <i class="fas fa-times"></i> Hủy
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
