import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { HttpClientModule } from '@angular/common/http';
import { Customer, CustomerRequestData } from '../../interfaces/customer.interface';
import { Address, AddressFormData, Province, District, Ward } from '../../interfaces/address.interface';
import { CustomerService } from '../../services/customer.service';

@Component({
  selector: 'app-customer-management',
  standalone: true,
  imports: [CommonModule, FormsModule, HttpClientModule],
  templateUrl: './customer-management.component.html',
  styleUrl: './customer-management.component.scss'
})
export class CustomerManagementComponent implements OnInit {
  // Customer data
  customers: Customer[] = [];
  filteredCustomers: Customer[] = [];
  paginatedCustomers: Customer[] = [];
  
  // Loading and error states
  isLoading = false;
  error: string | null = null;
  
  // Modal states
  showAddModal = false;
  showEditModal = false;
  showViewModal = false;
  selectedCustomer: Customer | null = null;
  editingCustomer: Customer | null = null;
  
  // Customer form data
  customerForm = {
    ho_ten: '',
    email: '',
    so_dien_thoai: '',
    ngay_sinh: new Date(),
    gioi_tinh: true, // true = Nam, false = N·ªØ
    // C√°c tr∆∞·ªùng b·ªï sung cho form
    name: '',
    phone: '',
    dateOfBirth: new Date(),
    gender: 'Nam',
    address: '',
    notes: ''
  };

  // Validation errors
  customerFormErrors: any = {};
  addressFormErrors: any = {};

  // Search and filter
  searchTerm = '';
  statusFilter = 'all'; // 'all', 'active', 'inactive'
  pointsFilter = 'all'; // 'all', 'high', 'medium', 'low'
  dateFilter = 'all'; // 'all', 'today', 'week', 'month'

  // Pagination
  currentPage = 1;
  itemsPerPage = 10;
  totalPages = 0;
  
  // Sorting
  sortField = 'ho_ten';
  sortDirection: 'asc' | 'desc' = 'asc';

  // Address management
  addresses: Address[] = [];
  showAddressAddModal = false;
  showAddressEditModal = false;
  selectedAddress: Address | null = null;
  currentAddressIndex = 0;
  newAddress = {
    diaChi: '',
    tinhThanh: '',
    quanHuyen: '',
    phuongXa: '',
    tenNguoiNhan: '',
    soDienThoai: '',
    macDinh: false
  };

  // Address form data
  addressForm: AddressFormData = {
    specificAddress: '',
    province: '',
    district: '',
    ward: '',
    isDefault: false
  };
  
  // Location data
  provinces: Province[] = [];
  districts: District[] = [];
  wards: Ward[] = [];
  filteredDistricts: District[] = [];
  filteredWards: Ward[] = [];

  constructor(private customerService: CustomerService) {}

  ngOnInit() {
    console.log('üöÄ Customer Management Component initialized');
    
    // Load d·ªØ li·ªáu ngay l·∫≠p t·ª©c
    this.loadLocationData();
    this.isLoading = false; // Kh√¥ng hi·ªÉn th·ªã loading
    this.loadFromLocalStorage(); // Load t·ª´ cache ngay l·∫≠p t·ª©c
    this.loadCustomers(); // Load t·ª´ backend ng·∫ßm
  }

  loadFromLocalStorage() {
    try {
      const cachedCustomers = localStorage.getItem('customers');
      if (cachedCustomers) {
        this.customers = JSON.parse(cachedCustomers);
    this.applyFilters();
        console.log('üì¶ Loaded customers from cache:', this.customers.length);
      }
    } catch (error) {
      console.error('‚ùå Error loading from cache:', error);
    }
  }

  loadCustomers() {
    this.error = null;
    // Kh√¥ng set loading state - load ng·∫ßm
    
    // Load t·ª´ backend ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t
    this.customerService.getCustomers().subscribe({
      next: (customers) => {
        console.log('‚úÖ Customers loaded from backend:', customers);
        // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ Spring Boot (c√≥ th·ªÉ l√† array ho·∫∑c object v·ªõi data property)
        this.customers = Array.isArray(customers) ? customers : (customers as any).data || [];
        this.saveToLocalStorage();
        this.applyFilters();
        // Kh√¥ng c·∫ßn clear loading state v√¨ kh√¥ng c√≥ loading
      },
      error: (error) => {
        console.error('‚ùå Error loading from backend:', error);
        
        // Fallback to localStorage n·∫øu backend l·ªói
        this.loadFromLocalStorage();
        this.error = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu m·ªõi t·ª´ server. ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu cache.';
        // Kh√¥ng c·∫ßn clear loading state v√¨ kh√¥ng c√≥ loading
      }
    });
  }

  loadSampleData() {
    // Fallback sample data v·ªõi c·∫•u tr√∫c database m·ªõi t·ª´ backend
    this.customers = [
      {
        id: 1,
        ho_ten: 'Nguyen Van An',
        email: 'an@email.com',
        so_dien_thoai: '0123456789',
        ngay_sinh: new Date('1990-01-15'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 100,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Nguyen Van An',
        phone: '0123456789',
        dateOfBirth: new Date('1990-01-15'),
        gender: 'Nam',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1000000,
        status: 'Active',
        diemTichLuy: 100,
        userId: undefined,
        diaChi: [{
          id: 1,
          tenDiaChi: 'Nha rieng An',
          thanhPho: 'Ha Noi',
          quan: 'Cau Giay',
          phuong: 'Dich Vong',
          diaChiCuThe: 'So 123 Duong ABC',
          macDinh: true
        }]
      },
      {
        id: 2,
        ho_ten: 'Tran Thi Binh',
        email: 'binh@email.com',
        so_dien_thoai: '0987654321',
        ngay_sinh: new Date('1985-05-20'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 200,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Tran Thi Binh',
        phone: '0987654321',
        dateOfBirth: new Date('1985-05-20'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 2000000,
        status: 'Active',
        diemTichLuy: 200,
        userId: undefined,
        diaChi: [{
          id: 2,
          tenDiaChi: 'Nha rieng Binh',
          thanhPho: 'TP HCM',
          quan: 'Quan 1',
          phuong: 'Ben Nghe',
          diaChiCuThe: 'So 456 Duong DEF',
          macDinh: true
        }]
      },
      {
        id: 3,
        ho_ten: 'Le Van Cuong',
        email: 'cuong@email.com',
        so_dien_thoai: '0111111111',
        ngay_sinh: new Date('1992-02-10'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 150,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Le Van Cuong',
        phone: '0111111111',
        dateOfBirth: new Date('1992-02-10'),
        gender: 'Nam',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1500000,
        status: 'Active',
        diemTichLuy: 150,
        userId: undefined,
        diaChi: [{
          id: 3,
          tenDiaChi: 'Nha rieng Cuong',
          thanhPho: 'Da Nang',
          quan: 'Hai Chau',
          phuong: 'Thach Thang',
          diaChiCuThe: 'So 789 Duong GHI',
          macDinh: true
        }]
      },
      {
        id: 4,
        ho_ten: 'Pham Thi Dung',
        email: 'dung@email.com',
        so_dien_thoai: '0222222222',
        ngay_sinh: new Date('1993-03-12'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 120,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Pham Thi Dung',
        phone: '0222222222',
        dateOfBirth: new Date('1993-03-12'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1200000,
        status: 'Active',
        diemTichLuy: 120,
        userId: undefined,
        diaChi: [{
          id: 4,
          tenDiaChi: 'Nha rieng Dung',
          thanhPho: 'Hai Phong',
          quan: 'Ngo Quyen',
          phuong: 'May To',
          diaChiCuThe: 'So 101 Duong JKL',
          macDinh: true
        }]
      },
      {
        id: 5,
        ho_ten: 'Hoang Van Em',
        email: 'em@email.com',
        so_dien_thoai: '0333333333',
        ngay_sinh: new Date('1994-04-14'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 180,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Hoang Van Em',
        phone: '0333333333',
        dateOfBirth: new Date('1994-04-14'),
        gender: 'Nam',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1800000,
        status: 'Active',
        diemTichLuy: 180,
        userId: undefined,
        diaChi: [{
          id: 5,
          tenDiaChi: 'Nha rieng Em',
          thanhPho: 'Can Tho',
          quan: 'Ninh Kieu',
          phuong: 'Xuan Khanh',
          diaChiCuThe: 'So 202 Duong MNO',
          macDinh: true
        }]
      },
      {
        id: 6,
        ho_ten: 'Ngo Thi Phuong',
        email: 'phuong@email.com',
        so_dien_thoai: '0444444444',
        ngay_sinh: new Date('1995-05-16'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 160,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Ngo Thi Phuong',
        phone: '0444444444',
        dateOfBirth: new Date('1995-05-16'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1600000,
        status: 'Active',
        diemTichLuy: 160,
        userId: undefined,
        diaChi: [{
          id: 6,
          tenDiaChi: 'Nha rieng Phuong',
          thanhPho: 'Hue',
          quan: 'Phu Nhuan',
          phuong: 'Phu Hoi',
          diaChiCuThe: 'So 303 Duong PQR',
          macDinh: true
        }]
      },
      {
        id: 7,
        ho_ten: 'Do Van Giang',
        email: 'giang@email.com',
        so_dien_thoai: '0555555555',
        ngay_sinh: new Date('1996-06-18'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 170,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Do Van Giang',
        phone: '0555555555',
        dateOfBirth: new Date('1996-06-18'),
        gender: 'Nam',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1700000,
        status: 'Active',
        diemTichLuy: 170,
        userId: undefined,
        diaChi: [{
          id: 7,
          tenDiaChi: 'Nha rieng Giang',
          thanhPho: 'Quang Ninh',
          quan: 'Ha Long',
          phuong: 'Bai Chay',
          diaChiCuThe: 'So 404 Duong STU',
          macDinh: true
        }]
      },
      {
        id: 8,
        ho_ten: 'Bui Thi Hoa',
        email: 'hoa@email.com',
        so_dien_thoai: '0666666666',
        ngay_sinh: new Date('1997-07-20'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 190,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Bui Thi Hoa',
        phone: '0666666666',
        dateOfBirth: new Date('1997-07-20'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1900000,
        status: 'Active',
        diemTichLuy: 190,
        userId: undefined,
        diaChi: [{
          id: 8,
          tenDiaChi: 'Nha rieng Hoa',
          thanhPho: 'Binh Duong',
          quan: 'Thu Dau Mot',
          phuong: 'Phu Hoa',
          diaChiCuThe: 'So 505 Duong VWX',
          macDinh: true
        }]
      },
      {
        id: 9,
        ho_ten: 'Vu Van Inh',
        email: 'inh@email.com',
        so_dien_thoai: '0777777777',
        ngay_sinh: new Date('1998-08-22'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 110,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Vu Van Inh',
        phone: '0777777777',
        dateOfBirth: new Date('1998-08-22'),
        gender: 'Nam',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1100000,
        status: 'Active',
        diemTichLuy: 110,
        userId: undefined,
        diaChi: [{
          id: 9,
          tenDiaChi: 'Nha rieng Inh',
          thanhPho: 'Nghe An',
          quan: 'Vinh',
          phuong: 'Hung Dung',
          diaChiCuThe: 'So 606 Duong YZA',
          macDinh: true
        }]
      },
      {
        id: 10,
        ho_ten: 'Phan Thi J',
        email: 'j@email.com',
        so_dien_thoai: '0888888888',
        ngay_sinh: new Date('1999-09-24'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-06-10'),
        diem_tich_luy: 130,
        trang_thai: true, // Active
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Phan Thi J',
        phone: '0888888888',
        dateOfBirth: new Date('1999-09-24'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-06-10'),
        totalSpent: 1300000,
        status: 'Active',
        diemTichLuy: 130,
        userId: undefined,
        diaChi: [{
          id: 10,
          tenDiaChi: 'Nha rieng J',
          thanhPho: 'Thanh Hoa',
          quan: 'Thanh Hoa',
          phuong: 'Dong Huong',
          diaChiCuThe: 'So 707 Duong BCD',
          macDinh: true
        }]
      },
      // Th√™m m·ªôt s·ªë kh√°ch h√†ng Inactive ƒë·ªÉ test
      {
        id: 11,
        ho_ten: 'Tran Van K',
        email: 'k@email.com',
        so_dien_thoai: '0999999999',
        ngay_sinh: new Date('1980-01-01'),
        gioi_tinh: true, // Nam
        ngay_tao: new Date('2024-01-01'),
        diem_tich_luy: 50,
        trang_thai: false, // Inactive
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Tran Van K',
        phone: '0999999999',
        dateOfBirth: new Date('1980-01-01'),
        gender: 'Nam',
        registrationDate: new Date('2024-01-01'),
        totalSpent: 500000,
        status: 'Inactive',
        diemTichLuy: 50,
        userId: undefined,
        diaChi: [{
          id: 11,
          tenDiaChi: 'Nha rieng K',
          thanhPho: 'Vung Tau',
          quan: 'Vung Tau',
          phuong: 'Thang Tam',
          diaChiCuThe: 'So 808 Duong EFG',
          macDinh: true
        }]
      },
      {
        id: 12,
        ho_ten: 'Le Thi L',
        email: 'l@email.com',
        so_dien_thoai: '0888888888',
        ngay_sinh: new Date('1985-02-02'),
        gioi_tinh: false, // N·ªØ
        ngay_tao: new Date('2024-02-02'),
        diem_tich_luy: 30,
        trang_thai: false, // Inactive
        // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
        name: 'Le Thi L',
        phone: '0888888888',
        dateOfBirth: new Date('1985-02-02'),
        gender: 'N·ªØ',
        registrationDate: new Date('2024-02-02'),
        totalSpent: 300000,
        status: 'Inactive',
        diemTichLuy: 30,
        userId: undefined,
        diaChi: [{
          id: 12,
          tenDiaChi: 'Nha rieng L',
          thanhPho: 'Nha Trang',
          quan: 'Nha Trang',
          phuong: 'Loc Tho',
          diaChiCuThe: 'So 909 Duong HIJ',
          macDinh: true
        }]
      }
    ];
    this.saveToLocalStorage();
    this.applyFilters();
  }

  // Validation errors
  customerErrors: any = {};
  addressErrors: any = {};

  // Clear errors when user starts typing
  clearError(field: string): void {
    if (this.customerErrors[field]) {
      delete this.customerErrors[field];
    }
  }

  clearAddressError(field: string): void {
    if (this.addressErrors[field]) {
      delete this.addressErrors[field];
    }
  }

  // Address helper methods
  getAddressSpecific(address: Address): string {
    return address.specificAddress || address.diaChiCuThe || 'Ch∆∞a c√≥ th√¥ng tin';
  }

  getAddressProvince(address: Address): string {
    return address.province || address.thanhPho || 'Ch∆∞a c√≥ th√¥ng tin';
  }

  getAddressDistrict(address: Address): string {
    return address.district || address.quan || 'Ch∆∞a c√≥ th√¥ng tin';
  }

  getAddressWard(address: Address): string {
    return address.ward || address.phuong || 'Ch∆∞a c√≥ th√¥ng tin';
  }

  getAddressDefault(address: Address): boolean {
    return address.isDefault || address.mac_dinh || false;
  }

  editAddress(address: Address): void {
    this.selectedAddress = address;
    this.showAddressEditModal = true;
    this.showAddressAddModal = false;
  }

  deleteAddress(address: Address): void {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?')) {
      const index = this.addresses.findIndex(a => a.id === address.id);
      if (index > -1) {
        this.addresses.splice(index, 1);
        if (this.currentAddressIndex >= this.addresses.length) {
          this.currentAddressIndex = Math.max(0, this.addresses.length - 1);
        }
        // Address deleted successfully
      }
    }
  }

  toggleDefaultAddress(address: Address): void {
    // B·ªè m·∫∑c ƒë·ªãnh t·∫•t c·∫£ ƒë·ªãa ch·ªâ kh√°c
    this.addresses.forEach(addr => {
      if (addr.id !== address.id) {
        addr.isDefault = false;
        addr.mac_dinh = false;
        addr.macDinh = false;
      }
    });
    
    // ƒê·∫∑t ƒë·ªãa ch·ªâ n√†y l√†m m·∫∑c ƒë·ªãnh
    address.isDefault = !address.isDefault;
    address.mac_dinh = address.isDefault;
    address.macDinh = address.isDefault;
    
    // Default address updated successfully
  }


  // Customer Form Methods
  saveCustomer() {
    // Clear previous errors
    this.customerFormErrors = {};
    this.addressFormErrors = {};
    
    // Validation c∆° b·∫£n
    if (!this.validateCustomerForm()) {
      return;
    }

    // Validation ƒë·ªãa ch·ªâ
    if (!this.validateAddresses()) {
      return;
    }

    // Kh√¥ng s·ª≠ d·ª•ng loading state

    // T·∫°o ƒë·ªãa ch·ªâ ch√≠nh t·ª´ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh ho·∫∑c ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n
    let primaryAddress = this.customerForm.address.trim();
    if (this.addresses.length > 0) {
      const defaultAddress = this.addresses.find(addr => addr.isDefault) || this.addresses[0];
      primaryAddress = `${defaultAddress.specificAddress}, ${defaultAddress.ward}, ${defaultAddress.district}, ${defaultAddress.province}`;
    }

    // T·∫°o m√£ kh√°ch h√†ng t·ª± ƒë·ªông
    let customerCode: string;
    if (this.showEditModal && this.selectedCustomer) {
      // S·ª≠a kh√°ch h√†ng - gi·ªØ nguy√™n m√£ c≈©
      customerCode = this.getCustomerCode(this.selectedCustomer);
    } else {
      // Th√™m kh√°ch h√†ng m·ªõi - t·∫°o m√£ m·ªõi
      const nextId = Math.max(...this.customers.map(c => c.id || 0), 0) + 1;
      customerCode = 'KH' + nextId.toString().padStart(5, '0');
    }

    // T·∫°o data ƒë·ªÉ g·ª≠i l√™n backend (format chu·∫©n)
    const customerRequestData: CustomerRequestData = {
      ho_ten: this.customerForm.ho_ten.trim(),
      email: this.customerForm.email.trim().toLowerCase(),
      so_dien_thoai: this.customerForm.so_dien_thoai.trim().replace(/\s/g, ''),
      ngay_sinh: this.customerForm.ngay_sinh instanceof Date 
        ? this.customerForm.ngay_sinh.toISOString().split('T')[0]
        : this.customerForm.ngay_sinh,
      gioi_tinh: this.customerForm.gioi_tinh,
      trang_thai: true, // Active
      customerCode: customerCode // Th√™m m√£ kh√°ch h√†ng
    };

    // T·∫°o data ƒë·ªÉ l∆∞u local (bao g·ªìm t·∫•t c·∫£ th√¥ng tin)
    const customerData: Customer = {
      id: this.showEditModal && this.selectedCustomer ? this.selectedCustomer.id : undefined,
      ho_ten: this.customerForm.ho_ten.trim(),
        email: this.customerForm.email.trim(),
      so_dien_thoai: this.customerForm.so_dien_thoai.trim(),
      ngay_sinh: this.customerForm.ngay_sinh,
      gioi_tinh: this.customerForm.gioi_tinh,
      ngay_tao: this.showEditModal && this.selectedCustomer ? this.selectedCustomer.ngay_tao : new Date().toISOString(),
      diem_tich_luy: this.showEditModal && this.selectedCustomer ? this.selectedCustomer.diem_tich_luy : 0,
      trang_thai: true, // Active
      customerCode: customerCode,
      addresses: [...this.addresses],
      // C√°c tr∆∞·ªùng b·ªï sung cho hi·ªÉn th·ªã
      name: this.customerForm.ho_ten.trim(),
      phone: this.customerForm.so_dien_thoai.trim(),
      dateOfBirth: this.customerForm.ngay_sinh,
      gender: this.customerForm.gioi_tinh ? 'Nam' : 'N·ªØ',
      registrationDate: this.showEditModal && this.selectedCustomer ? this.selectedCustomer.registrationDate : new Date().toISOString(),
      totalSpent: this.showEditModal && this.selectedCustomer ? this.selectedCustomer.totalSpent : 0,
      status: 'Active'
    };

    // G·ªçi API backend ƒë·ªÉ l∆∞u v√†o database
    console.log('üîç Sending to backend:', customerRequestData);
    console.log('üîç API URL:', this.showEditModal ? 'UPDATE' : 'CREATE');
    console.log('üîç Backend URL:', 'http://localhost:8081/api/khach-hang');
    console.log('üîç Customer Code:', customerCode);
    
    const operation = this.showEditModal && this.selectedCustomer && this.selectedCustomer.id
      ? this.customerService.updateCustomer(this.selectedCustomer.id, customerRequestData)
      : this.customerService.createCustomer(customerRequestData);

    // G·ªçi API backend v√† ch·ªù response
    operation.subscribe({
      next: (savedCustomer) => {
        console.log('‚úÖ Customer saved to backend:', savedCustomer);
        
        // C·∫≠p nh·∫≠t danh s√°ch kh√°ch h√†ng t·ª´ backend
        this.loadCustomers();
        // Customer saved successfully
        
        // ƒê√≥ng modal v√† reset form
    this.closeModals();
        this.resetForm();
      },
      error: (error) => {
        console.error('‚ùå Error saving to backend:', error);
        console.error('‚ùå Error details:', {
          status: error.status,
          statusText: error.statusText,
          message: error.message,
          url: error.url,
          error: error.error
        });
        
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói chi ti·∫øt h∆°n
        let errorMessage = '‚ùå L·ªói khi l∆∞u kh√°ch h√†ng. ';
        
        if (error.status === 0) {
          errorMessage += 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra backend c√≥ ƒëang ch·∫°y kh√¥ng.';
        } else if (error.status === 400) {
          errorMessage += 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.';
        } else if (error.status === 500) {
          errorMessage += 'L·ªói server. Vui l√≤ng th·ª≠ l·∫°i sau.';
        } else if (error.status === 404) {
          errorMessage += 'API endpoint kh√¥ng t√¨m th·∫•y. Vui l√≤ng ki·ªÉm tra backend.';
        } else {
          const statusText = error.statusText || 'Unknown Error';
          const status = error.status || 'Unknown';
          errorMessage += `L·ªói ${status}: ${statusText}`;
        }
        
        // Th√™m th√¥ng tin debug n·∫øu c√≥
        if (error.error && typeof error.error === 'string') {
          errorMessage += `\n\nChi ti·∫øt: ${error.error}`;
        }
        
        console.error('Error:', errorMessage);
      }
    });
  }

  // Address Management Methods
  loadLocationData() {
    // Sample provinces
    this.provinces = [
      { id: 'hcm', name: 'Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { id: 'hn', name: 'H√† N·ªôi' },
      { id: 'dn', name: 'ƒê√† N·∫µng' }
    ];

    // Sample districts
    this.districts = [
      { id: 'q1', name: 'Qu·∫≠n 1', provinceId: 'hcm' },
      { id: 'q2', name: 'Qu·∫≠n 2', provinceId: 'hcm' },
      { id: 'bt', name: 'Qu·∫≠n Ba ƒê√¨nh', provinceId: 'hn' },
      { id: 'hk', name: 'Qu·∫≠n Ho√†n Ki·∫øm', provinceId: 'hn' },
      { id: 'hc', name: 'Qu·∫≠n H·∫£i Ch√¢u', provinceId: 'dn' }
    ];

    // Sample wards
    this.wards = [
      { id: 'p1', name: 'Ph∆∞·ªùng B·∫øn Ngh√©', districtId: 'q1' },
      { id: 'p2', name: 'Ph∆∞·ªùng B·∫øn Th√†nh', districtId: 'q1' },
      { id: 'p3', name: 'Ph∆∞·ªùng C·∫ßu Kho', districtId: 'q1' },
      { id: 'p4', name: 'Ph∆∞·ªùng Th·∫°nh Xu√¢n', districtId: 'q2' },
      { id: 'p5', name: 'Ph∆∞·ªùng Th·ªß Thi√™m', districtId: 'q2' },
      { id: 'p6', name: 'Ph∆∞·ªùng Ph√∫c X√°', districtId: 'bt' },
      { id: 'p7', name: 'Ph∆∞·ªùng Tr√∫c B·∫°ch', districtId: 'bt' },
      { id: 'p8', name: 'Ph∆∞·ªùng H√†ng B·∫°c', districtId: 'hk' },
      { id: 'p9', name: 'Ph∆∞·ªùng H√†ng Bu·ªìm', districtId: 'hk' },
      { id: 'p10', name: 'Ph∆∞·ªùng H·∫£i Ch√¢u I', districtId: 'hc' }
    ];
  }

  loadAddressSampleData() {
    this.addresses = [
      {
        id: 1,
        specificAddress: '123 Nguy·ªÖn Hu·ªá',
        province: 'Th√†nh ph·ªë H·ªì Ch√≠ Minh',
        district: 'Qu·∫≠n 1',
        ward: 'Ph∆∞·ªùng B·∫øn Ngh√©',
        isDefault: true,
        mac_dinh: true,
        dia_chi: '123 Nguy·ªÖn Hu·ªá, Ph∆∞·ªùng B·∫øn Ngh√©, Qu·∫≠n 1, Th√†nh ph·ªë H·ªì Ch√≠ Minh',
        createdAt: new Date('2023-01-15'),
        updatedAt: new Date('2023-01-15')
      }
    ];
  }

  // Address Navigation
  previousAddress() {
    if (this.currentAddressIndex > 0) {
      this.currentAddressIndex--;
    }
  }

  nextAddress() {
    if (this.currentAddressIndex < this.addresses.length - 1) {
      this.currentAddressIndex++;
    }
  }

  // Address Modal methods
  openAddressAddModal() {
    this.resetAddressForm();
    this.showAddressAddModal = true;
  }

  openAddressEditModal(address: Address) {
    this.selectedAddress = address;
    this.addressForm = {
      specificAddress: address.specificAddress || '',
      province: this.getProvinceIdByName(address.province || ''),
      district: this.getDistrictIdByName(address.district || ''),
      ward: this.getWardIdByName(address.ward || ''),
      isDefault: address.isDefault || false
    };
    this.onProvinceChange();
    this.onDistrictChange();
    this.showAddressEditModal = true;
  }


  closeAddressModals() {
    this.showAddressAddModal = false;
    this.showAddressEditModal = false;
    this.selectedAddress = null;
    this.resetAddressForm();
  }

  resetAddressForm() {
    this.addressForm = {
      specificAddress: '',
      province: '',
      district: '',
      ward: '',
      isDefault: false
    };
    this.filteredDistricts = [];
    this.filteredWards = [];
  }

  // Address Form methods
  onProvinceChange() {
    this.filteredDistricts = this.districts.filter(d => d.provinceId === this.addressForm.province);
    this.addressForm.district = '';
    this.addressForm.ward = '';
    this.filteredWards = [];
  }

  onDistrictChange() {
    this.filteredWards = this.wards.filter(w => w.districtId === this.addressForm.district);
    this.addressForm.ward = '';
  }

  saveAddress() {
    console.log('üîÑ Starting saveAddress...');
    console.log('üìã Address form data:', this.addressForm);
    console.log('üë§ Selected customer:', this.selectedCustomer);
    console.log('üè† Current addresses:', this.addresses.length);
    console.log('üìù ShowAddModal:', this.showAddModal);
    console.log('üìù ShowAddressAddModal:', this.showAddressAddModal);
    console.log('üìù ShowAddressEditModal:', this.showAddressEditModal);
    
    // Clear previous errors
    this.addressFormErrors = {};
    
    // Validation ƒë·ªãa ch·ªâ chi ti·∫øt
    if (!this.validateAddressForm()) {
      console.log('‚ùå Address validation failed');
      return;
    }
    
    console.log('‚úÖ Address validation passed');

    const addressData: Address = {
      id: this.showAddressEditModal && this.selectedAddress ? this.selectedAddress.id : undefined,
          specificAddress: this.addressForm.specificAddress.trim(),
          province: this.getProvinceNameById(this.addressForm.province) || 'Ch∆∞a ch·ªçn',
          district: this.getDistrictNameById(this.addressForm.district) || 'Ch∆∞a ch·ªçn',
          ward: this.getWardNameById(this.addressForm.ward) || 'Ch∆∞a ch·ªçn',
      isDefault: this.addressForm.isDefault || false,
      mac_dinh: this.addressForm.isDefault || false,
      macDinh: this.addressForm.isDefault || false,
      dia_chi: `${this.addressForm.specificAddress.trim()}, ${this.getWardNameById(this.addressForm.ward) || 'Ch∆∞a ch·ªçn'}, ${this.getDistrictNameById(this.addressForm.district) || 'Ch∆∞a ch·ªçn'}, ${this.getProvinceNameById(this.addressForm.province) || 'Ch∆∞a ch·ªçn'}`,
      // Database m·ªõi fields
      diaChiCuThe: this.addressForm.specificAddress.trim(),
      thanhPho: this.getProvinceNameById(this.addressForm.province) || 'Ch∆∞a ch·ªçn',
      quan: this.getDistrictNameById(this.addressForm.district) || 'Ch∆∞a ch·ªçn',
      phuong: this.getWardNameById(this.addressForm.ward) || 'Ch∆∞a ch·ªçn',
      tenDiaChi: `ƒê·ªãa ch·ªâ ${this.addresses.length + 1}`,
      soDienThoai: this.selectedCustomer?.so_dien_thoai || this.selectedCustomer?.phone || '0123456789',
      tenNguoiNhan: this.selectedCustomer?.ho_ten || this.selectedCustomer?.name || 'Kh√°ch h√†ng',
      createdAt: this.showAddressEditModal && this.selectedAddress ? this.selectedAddress.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      customerId: this.selectedCustomer?.id
    };

    // N·∫øu ƒëang th√™m ƒë·ªãa ch·ªâ cho kh√°ch h√†ng m·ªõi (ch∆∞a c√≥ ID) ho·∫∑c ƒëang trong modal th√™m kh√°ch h√†ng
    if ((this.showAddModal && !this.selectedCustomer?.id) || this.showAddressAddModal) {
      // Ch·ªâ l∆∞u v√†o local array cho kh√°ch h√†ng m·ªõi
      console.log('üîÑ Adding address for new customer (local only)');
      console.log('üìù ShowAddModal:', this.showAddModal);
      console.log('üìù ShowAddressAddModal:', this.showAddressAddModal);
      console.log('üë§ SelectedCustomer ID:', this.selectedCustomer?.id);
      console.log('üîç Condition check: showAddModal && !selectedCustomer?.id =', this.showAddModal && !this.selectedCustomer?.id);
      console.log('üîç Condition check: showAddressAddModal =', this.showAddressAddModal);

      if (this.showAddressEditModal && this.selectedAddress) {
        // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ hi·ªán c√≥
        const index = this.addresses.findIndex(a => a.id === this.selectedAddress!.id);
        if (index > -1) {
          this.addresses[index] = {
            ...this.addresses[index],
            ...addressData,
            updatedAt: new Date().toISOString()
          };
        }
        console.log('‚úÖ Address updated in local array');
      } else {
        // Th√™m ƒë·ªãa ch·ªâ m·ªõi
        console.log('üîÑ Adding new address to local array...');
        const newId = this.addresses.length > 0 ? Math.max(...this.addresses.map(a => a.id || 0)) + 1 : 1;
        console.log('üÜî Generated new ID:', newId);
        
        const newAddress: Address = {
          ...addressData,
          id: newId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        console.log('üì¶ New address object:', newAddress);
        this.addresses.push(newAddress);
        this.currentAddressIndex = this.addresses.length - 1;
        console.log('‚úÖ Address added to local array:', newAddress);
        console.log('üìã Total addresses now:', this.addresses.length);
        
        // C·∫≠p nh·∫≠t customerForm.address ƒë·ªÉ hi·ªÉn th·ªã trong form
        this.customerForm.address = newAddress.dia_chi || '';
        console.log('üìù Updated customerForm.address:', this.customerForm.address);
      }
      
      this.closeAddressModals();
      return;
    }

    // N·∫øu ƒëang th√™m ƒë·ªãa ch·ªâ cho kh√°ch h√†ng ƒë√£ c√≥ ID
    if (this.selectedCustomer && this.selectedCustomer.id) {
      console.log('üîÑ Adding address for existing customer with ID:', this.selectedCustomer.id);
      if (this.showAddressEditModal && this.selectedAddress && this.selectedAddress.id) {
        // G·ªçi API backend ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ
        this.customerService.updateCustomerAddress(this.selectedCustomer.id, this.selectedAddress.id, addressData).subscribe({
          next: (updatedAddress) => {
            console.log('‚úÖ C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ th√†nh c√¥ng t·ª´ database:', updatedAddress);
            
            // C·∫≠p nh·∫≠t local array v·ªõi d·ªØ li·ªáu t·ª´ backend
            const index = this.addresses.findIndex(a => a.id === this.selectedAddress!.id);
            if (index > -1) {
              this.addresses[index] = updatedAddress;
            }
            
            // Address updated successfully
    this.closeAddressModals();
          },
          error: (error) => {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ trong database:', error);
            console.error('Error updating address');
          }
        });
      } else {
        // G·ªçi API backend ƒë·ªÉ th√™m ƒë·ªãa ch·ªâ m·ªõi
        this.customerService.addCustomerAddress(this.selectedCustomer.id, addressData).subscribe({
          next: (newAddress) => {
            console.log('‚úÖ Th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng t·ª´ database:', newAddress);
            
            // Th√™m ƒë·ªãa ch·ªâ m·ªõi v√†o local array
            this.addresses.push(newAddress);
            this.currentAddressIndex = this.addresses.length - 1;
            
            // Address added successfully
            this.closeAddressModals();
          },
          error: (error) => {
            console.error('‚ùå L·ªói khi th√™m ƒë·ªãa ch·ªâ v√†o database:', error);
            console.error('Error adding address');
          }
        });
      }
    } else {
      console.log('‚ùå Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng ƒë·ªÉ th√™m ƒë·ªãa ch·ªâ!');
      console.log('üìã Debug info:');
      console.log('- selectedCustomer:', this.selectedCustomer);
      console.log('- selectedCustomer.id:', this.selectedCustomer?.id);
      console.log('- showAddModal:', this.showAddModal);
      console.log('- showAddressAddModal:', this.showAddressAddModal);
      console.log('- showAddressEditModal:', this.showAddressEditModal);
      console.log('üîç Final condition check:');
      console.log('  - (showAddModal && !selectedCustomer?.id) =', this.showAddModal && !this.selectedCustomer?.id);
      console.log('  - showAddressAddModal =', this.showAddressAddModal);
      console.log('  - (selectedCustomer && selectedCustomer.id) =', this.selectedCustomer && this.selectedCustomer.id);
    }
  }


  setAddressAsDefault(address: Address) {
    if (!address.isDefault) {
      // N·∫øu ƒëang th√™m kh√°ch h√†ng m·ªõi, ch·ªâ c·∫≠p nh·∫≠t local array
      if (this.showAddModal && !this.selectedCustomer) {
      // Unset all other defaults
      this.addresses.forEach(addr => {
        addr.isDefault = false;
      });
      
      // Set this as default
      address.isDefault = true;
      console.log('‚úÖ ƒê√£ ƒë·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh!');
        return;
      }

      // N·∫øu ƒëang s·ª≠a kh√°ch h√†ng, g·ª≠i l√™n server
      if (this.selectedCustomer && this.selectedCustomer.id && address.id) {
        console.log('üîÑ ƒêang ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh trong database...', address);
        
        this.customerService.setDefaultAddress(this.selectedCustomer.id, address.id).subscribe({
          next: (updatedAddress) => {
            console.log('‚úÖ ƒê·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh th√†nh c√¥ng t·ª´ database:', updatedAddress);
            
            // Update address in local array
            const index = this.addresses.findIndex(a => a.id === address.id);
            if (index > -1) {
              this.addresses[index] = updatedAddress;
            }
            
            // Unset all other defaults
            this.addresses.forEach(addr => {
              if (addr.id !== address.id) {
                addr.isDefault = false;
              }
            });
            
            // C·∫≠p nh·∫≠t customer trong local storage
            if (this.selectedCustomer && this.selectedCustomer.id) {
              const customerIndex = this.customers.findIndex(c => c.id === this.selectedCustomer!.id);
              if (customerIndex > -1) {
                this.customers[customerIndex].addresses = [...this.addresses];
                this.saveToLocalStorage();
              }
            }
            
            console.log('‚úÖ ƒê√£ ƒë·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh trong database!');
          },
          error: (error) => {
            console.error('‚ùå L·ªói khi ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh trong database:', error);
            
            // Fallback: update local data
            this.addresses.forEach(addr => {
              addr.isDefault = false;
            });
            address.isDefault = true;
            
            if (error.status === 400) {
              console.log('‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.');
            } else if (error.status === 404) {
              console.log('‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ ho·∫∑c kh√°ch h√†ng! Vui l√≤ng th·ª≠ l·∫°i.');
            } else if (error.status === 500) {
              console.log('‚ùå L·ªói server! Kh√¥ng th·ªÉ ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh.');
            } else {
              console.log('‚ùå L·ªói k·∫øt n·ªëi! Kh√¥ng th·ªÉ ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh trong database.');
            }
          }
        });
      }
    }
  }

  // Address Helper methods
  getProvinceIdByName(name: string): string {
    const province = this.provinces.find(p => p.name === name);
    return province ? province.id : '';
  }

  getDistrictIdByName(name: string): string {
    const district = this.districts.find(d => d.name === name);
    return district ? district.id : '';
  }

  getWardIdByName(name: string): string {
    const ward = this.wards.find(w => w.name === name);
    return ward ? ward.id : '';
  }

  getProvinceNameById(id: string): string {
    const province = this.provinces.find(p => p.id === id);
    return province ? province.name : '';
  }

  getDistrictNameById(id: string): string {
    const district = this.districts.find(d => d.id === id);
    return district ? district.name : '';
  }

  getWardNameById(id: string): string {
    const ward = this.wards.find(w => w.id === id);
    return ward ? ward.name : '';
  }

  // Customer Management Methods
  applyFilters() {
    console.log('üîç Applying filters - Status filter:', this.statusFilter);
    console.log('üìä Total customers:', this.customers.length);
    
    this.filteredCustomers = this.customers.filter(customer => {
      // Search filter
      const searchMatch = !this.searchTerm || 
        (customer.ho_ten || customer.name || '').toLowerCase().includes(this.searchTerm.toLowerCase()) ||
        (customer.email || '').toLowerCase().includes(this.searchTerm.toLowerCase()) ||
        (customer.so_dien_thoai || customer.phone || '').toLowerCase().includes(this.searchTerm.toLowerCase()) ||
        this.getCustomerCode(customer).toLowerCase().includes(this.searchTerm.toLowerCase());
      
      // Status filter - check both boolean and string status
      const isActive = customer.trang_thai === true || 
        customer.status === 'Active' || 
        (customer.status as string)?.toLowerCase() === 'active';
      const statusMatch = this.statusFilter === 'all' || 
        (this.statusFilter === 'active' && isActive) ||
        (this.statusFilter === 'inactive' && !isActive);
      
      // Debug log for each customer
      if (this.statusFilter !== 'all') {
        console.log(`üë§ ${customer.ho_ten || customer.name}: trang_thai=${customer.trang_thai}, status=${customer.status}, isActive=${isActive}, statusMatch=${statusMatch}`);
      }
      
      // Points filter
      const points = customer.diem_tich_luy || customer.diemTichLuy || 0;
      const pointsMatch = this.pointsFilter === 'all' ||
        (this.pointsFilter === 'high' && points >= 1000) ||
        (this.pointsFilter === 'medium' && points >= 100 && points < 1000) ||
        (this.pointsFilter === 'low' && points < 100);
      
      // Date filter
      const customerDate = new Date(customer.ngay_tao || customer.registrationDate || '');
      const now = new Date();
      const dateMatch = this.dateFilter === 'all' ||
        (this.dateFilter === 'today' && this.isSameDay(customerDate, now)) ||
        (this.dateFilter === 'week' && this.isSameWeek(customerDate, now)) ||
        (this.dateFilter === 'month' && this.isSameMonth(customerDate, now));
      
      return searchMatch && statusMatch && pointsMatch && dateMatch;
    });
    
    console.log('‚úÖ Filtered customers:', this.filteredCustomers.length);
    console.log('üìã Status filter result:', this.statusFilter, '‚Üí', this.filteredCustomers.length, 'customers');
    
    this.currentPage = 1;
    this.updatePagination();
  }

  resetFilters() {
    this.searchTerm = '';
    this.statusFilter = 'all';
    this.pointsFilter = 'all';
    this.dateFilter = 'all';
    this.applyFilters();
  }

  // Modal Methods
  openAddModal() {
    this.resetForm();
    // Force clear addresses khi th√™m kh√°ch h√†ng m·ªõi
    this.addresses = [];
    this.currentAddressIndex = 0;
    this.selectedCustomer = null;
    
    // Clear validation errors khi m·ªü modal add
    this.customerFormErrors = {};
    this.addressErrors = {};
    
    this.showAddModal = true;
  }

  openEditModal(customer: Customer) {
    this.selectedCustomer = customer;
    
    // Clear validation errors khi m·ªü modal edit
    this.customerFormErrors = {};
    this.addressErrors = {};
    
    this.customerForm = {
      ho_ten: customer.ho_ten || customer.name || '',
      email: customer.email,
      so_dien_thoai: customer.so_dien_thoai || customer.phone || '',
      ngay_sinh: typeof customer.ngay_sinh === 'string' ? new Date(customer.ngay_sinh) : (customer.ngay_sinh || new Date()),
      gioi_tinh: customer.gioi_tinh !== undefined ? customer.gioi_tinh : (customer.gender === 'Nam'),
      // C√°c tr∆∞·ªùng b·ªï sung cho form
      name: customer.name || customer.ho_ten || '',
      phone: customer.phone || customer.so_dien_thoai || '',
      dateOfBirth: typeof customer.dateOfBirth === 'string' ? new Date(customer.dateOfBirth) : (customer.dateOfBirth || new Date()),
      gender: customer.gender || (customer.gioi_tinh ? 'Nam' : 'N·ªØ'),
      address: customer.address || '',
      notes: customer.notes || ''
    };
    
    // Load ƒë·ªãa ch·ªâ chi ti·∫øt t·ª´ API
    this.loadCustomerAddresses(customer.id);
    
    // Hi·ªÉn th·ªã modal
    this.showEditModal = true;
  }

  loadCustomerAddresses(customerId: number | undefined) {
    if (!customerId) {
      this.addresses = [];
      this.currentAddressIndex = 0;
      return;
    }
    
    console.log('üîç Loading addresses for customer:', customerId);
    
    // Load addresses directly
    this.customerService.getCustomerAddresses(customerId).subscribe({
      next: (addresses) => {
        console.log('‚úÖ Addresses loaded successfully:', addresses);
        this.addresses = addresses || [];
        this.currentAddressIndex = 0;
        
        // N·∫øu kh√¥ng c√≥ ƒë·ªãa ch·ªâ, t·∫°o ƒë·ªãa ch·ªâ m·∫´u
        if (this.addresses.length === 0) {
          console.log('‚ö†Ô∏è No addresses found, creating sample address');
          this.createSampleAddress(customerId);
        } else {
          // T·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh v√†o tr∆∞·ªùng "ƒê·ªãa ch·ªâ" ch√≠nh (database m·ªõi)
          const defaultAddress = this.addresses.find(addr => addr.isDefault || addr.macDinh) || this.addresses[0];
          if (defaultAddress) {
            const fullAddress = `${defaultAddress.diaChiCuThe || defaultAddress.specificAddress}, ${defaultAddress.phuong || defaultAddress.ward}, ${defaultAddress.quan || defaultAddress.district}, ${defaultAddress.thanhPho || defaultAddress.province}`;
            this.customerForm.address = fullAddress;
          }
        }
      },
      error: (error) => {
        console.error('‚ùå Error loading addresses:', error);
        this.addresses = [];
        this.currentAddressIndex = 0;
        // T·∫°o ƒë·ªãa ch·ªâ m·∫´u khi c√≥ l·ªói
        this.createSampleAddress(customerId);
      }
    });
  }

  createSampleAddress(customerId: number) {
    const sampleAddress: Address = {
      id: 1,
      specificAddress: '123 ƒê∆∞·ªùng ABC',
      province: 'H√† N·ªôi',
      district: 'Qu·∫≠n Ba ƒê√¨nh',
      ward: 'Ph∆∞·ªùng Ph√∫c X√°',
      isDefault: true,
      mac_dinh: true,
      macDinh: true,
      dia_chi: '123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng Ph√∫c X√°, Qu·∫≠n Ba ƒê√¨nh, H√† N·ªôi',
      diaChiCuThe: '123 ƒê∆∞·ªùng ABC',
      thanhPho: 'H√† N·ªôi',
      quan: 'Qu·∫≠n Ba ƒê√¨nh',
      phuong: 'Ph∆∞·ªùng Ph√∫c X√°',
      tenDiaChi: 'ƒê·ªãa ch·ªâ nh√†',
      soDienThoai: '0123456789',
      tenNguoiNhan: 'Kh√°ch h√†ng',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      customerId: customerId
    };
    
    this.addresses = [sampleAddress];
    this.currentAddressIndex = 0;
    
    // T·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ m·∫´u
    this.customerForm.address = sampleAddress.dia_chi || `${sampleAddress.specificAddress}, ${sampleAddress.ward}, ${sampleAddress.district}, ${sampleAddress.province}`;
    
    console.log('‚úÖ Sample address created:', sampleAddress);
  }


  closeModals() {
    this.showAddModal = false;
    this.showEditModal = false;
    this.showViewModal = false;
    this.selectedCustomer = null;
    // Reset addresses khi ƒë√≥ng modal
    this.addresses = [];
    this.currentAddressIndex = 0;
    
    // Clear validation errors khi ƒë√≥ng modal
    this.customerFormErrors = {};
    this.addressErrors = {};
    
    this.resetForm();
  }


  resetForm() {
    this.customerForm = {
      ho_ten: '',
      email: '',
      so_dien_thoai: '',
      ngay_sinh: new Date(),
      gioi_tinh: true, // true = Nam, false = N·ªØ
      // C√°c tr∆∞·ªùng b·ªï sung cho form
      name: '',
      phone: '',
      dateOfBirth: new Date(),
      gender: 'Nam',
      address: '',
      notes: ''
    };
    
    // Reset addresses khi reset form
    this.addresses = [];
    this.currentAddressIndex = 0;
  }



  // Sorting Methods
  sortCustomers(field: string) {
    if (this.sortField === field) {
      this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortField = field;
      this.sortDirection = 'asc';
    }
    
    this.filteredCustomers.sort((a, b) => {
      let aValue = this.getFieldValue(a, field);
      let bValue = this.getFieldValue(b, field);
      
      // Handle different data types
      if (typeof aValue === 'string' && typeof bValue === 'string') {
        aValue = aValue.toLowerCase();
        bValue = bValue.toLowerCase();
      }
      
      if (aValue < bValue) {
        return this.sortDirection === 'asc' ? -1 : 1;
      }
      if (aValue > bValue) {
        return this.sortDirection === 'asc' ? 1 : -1;
      }
      return 0;
    });
    
    this.updatePagination();
  }
  
  getFieldValue(customer: Customer, field: string): any {
    switch (field) {
      case 'ho_ten': return customer.ho_ten || customer.name || '';
      case 'email': return customer.email || '';
      case 'so_dien_thoai': return customer.so_dien_thoai || customer.phone || '';
      case 'ngay_sinh': return customer.ngay_sinh || customer.dateOfBirth || '';
      case 'diem_tich_luy': return customer.diem_tich_luy || customer.diemTichLuy || 0;
      case 'ngay_tao': return customer.ngay_tao || customer.registrationDate || '';
      case 'trang_thai': return this.getCustomerStatus(customer);
      default: return '';
    }
  }
  
  getSortIcon(field: string): string {
    if (this.sortField !== field) return '‚ÜïÔ∏è';
    return this.sortDirection === 'asc' ? '‚Üë' : '‚Üì';
  }
  
  getFieldDisplayName(field: string): string {
    switch (field) {
      case 'ho_ten': return 'T√™n kh√°ch h√†ng';
      case 'email': return 'Email';
      case 'so_dien_thoai': return 'S·ªë ƒëi·ªán tho·∫°i';
      case 'ngay_sinh': return 'Ng√†y sinh';
      case 'diem_tich_luy': return 'ƒêi·ªÉm t√≠ch l≈©y';
      case 'ngay_tao': return 'Ng√†y t·∫°o';
      case 'trang_thai': return 'Tr·∫°ng th√°i';
      default: return field;
    }
  }
  
  resetSorting() {
    this.sortField = 'ho_ten';
    this.sortDirection = 'asc';
    this.applyFilters();
  }

  // Pagination Methods
  updatePagination() {
    this.totalPages = Math.ceil(this.filteredCustomers.length / this.itemsPerPage);
    this.currentPage = Math.min(this.currentPage, this.totalPages || 1);
    
    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
    const endIndex = startIndex + this.itemsPerPage;
    this.paginatedCustomers = this.filteredCustomers.slice(startIndex, endIndex);
  }

  onItemsPerPageChange() {
    this.currentPage = 1;
    this.updatePagination();
  }

  goToPage(page: number) {
    this.currentPage = page;
    this.updatePagination();
  }

  previousPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.updatePagination();
    }
  }

  nextPage() {
    if (this.currentPage < this.totalPages) {
      this.currentPage++;
      this.updatePagination();
    }
  }

  goToFirstPage() {
    this.currentPage = 1;
    this.updatePagination();
  }

  goToLastPage() {
    this.currentPage = this.totalPages;
    this.updatePagination();
  }


  // Utility Methods
  onMouseEnter(event: any) {
    (event.target as HTMLElement).style.backgroundColor = '#f8f9fa';
  }

  onMouseLeave(event: any) {
    (event.target as HTMLElement).style.backgroundColor = '';
  }

  // LocalStorage methods
  saveToLocalStorage() {
    try {
      localStorage.setItem('customers', JSON.stringify(this.customers));
      console.log('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu v√†o localStorage');
    } catch (error) {
      console.error('‚ùå L·ªói khi l∆∞u v√†o localStorage:', error);
    }
  }


  // Helper method ƒë·ªÉ l·∫•y tr·∫°ng th√°i kh√°ch h√†ng
  getCustomerStatus(customer: Customer): 'Active' | 'Inactive' {
    // ∆Øu ti√™n status string tr∆∞·ªõc, sau ƒë√≥ m·ªõi ƒë·∫øn trang_thai boolean
    if (customer.status) {
      return customer.status;
    }
    if (customer.trang_thai !== undefined) {
      return customer.trang_thai ? 'Active' : 'Inactive';
    }
    // M·∫∑c ƒë·ªãnh l√† Active n·∫øu kh√¥ng c√≥ th√¥ng tin
    return 'Active';
  }





  // Method ƒë·ªÉ hi·ªÉn th·ªã th√¥ng tin ƒë·ªãa ch·ªâ chi ti·∫øt
  showAddressDetails(): void {
    if (this.addresses.length === 0) {
      console.log('‚ùå Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o!');
      return;
    }
    
    let addressInfo = 'üè† Danh s√°ch ƒë·ªãa ch·ªâ:\n\n';
    this.addresses.forEach((address, index) => {
      const isDefault = this.getAddressDefault(address) ? ' (M·∫∑c ƒë·ªãnh)' : '';
      addressInfo += `${index + 1}. ${address.tenDiaChi || address.specificAddress || 'ƒê·ªãa ch·ªâ'}: ${address.diaChiCuThe || address.specificAddress || 'Ch∆∞a c·∫≠p nh·∫≠t'}${isDefault}\n`;
    });
    
    console.log(addressInfo);
  }



  // Method ƒë·ªÉ format date cho input
  formatDateForInput(date: Date | string | undefined): string {
    if (!date) return '';
    const d = typeof date === 'string' ? new Date(date) : date;
    return d.toISOString().split('T')[0];
  }

  // Method ƒë·ªÉ x·ª≠ l√Ω thay ƒë·ªïi ng√†y sinh
  onDateChange(event: any): void {
    const value = event.target.value;
    if (value) {
      this.customerForm.ngay_sinh = new Date(value);
    }
  }

  // Method ƒë·ªÉ format ng√†y th√°ng
  formatDate(date: Date | string | undefined): string {
    if (!date) return 'Ch∆∞a c·∫≠p nh·∫≠t';
    const d = typeof date === 'string' ? new Date(date) : date;
    return d.toLocaleDateString('vi-VN');
  }


  getStartItem(): number {
    return (this.currentPage - 1) * this.itemsPerPage + 1;
  }

  getEndItem(): number {
    const end = this.currentPage * this.itemsPerPage;
    return Math.min(end, this.filteredCustomers.length);
  }

  getPageNumbers(): number[] {
    const pages: number[] = [];
    const maxPages = Math.min(5, this.totalPages);
    const startPage = Math.max(1, this.currentPage - 2);
    const endPage = Math.min(this.totalPages, startPage + maxPages - 1);
    
    for (let i = startPage; i <= endPage; i++) {
      pages.push(i);
    }
    return pages;
  }


  viewCustomer(customer: Customer): void {
    this.selectedCustomer = customer;
    this.showViewModal = true;
  }

  getCustomerCode(customer: any): string {
    // ∆Øu ti√™n maKhachHang t·ª´ backend tr∆∞·ªõc
    if (customer.maKhachHang) {
      return customer.maKhachHang;
    }
    // Fallback v·ªÅ id n·∫øu kh√¥ng c√≥ maKhachHang
    if (customer.id) {
      return `KH${customer.id.toString().padStart(6, '0')}`;
    }
    return 'N/A';
  }

  getCustomerBirthday(customer: any): string {
    // ∆Øu ti√™n ngaySinh t·ª´ backend tr∆∞·ªõc
    if (customer.ngaySinh) {
      return new Date(customer.ngaySinh).toLocaleDateString('vi-VN');
    }
    // Fallback v·ªÅ ngay_sinh
    if (customer.ngay_sinh) {
      return new Date(customer.ngay_sinh).toLocaleDateString('vi-VN');
    }
    return 'Ch∆∞a c·∫≠p nh·∫≠t';
  }

  getCustomerAddress(customer: any): string {
    if (customer.diaChiList && customer.diaChiList.length > 0) {
      const defaultAddress = customer.diaChiList.find((addr: any) => addr.macDinh === true);
      const address = defaultAddress || customer.diaChiList[0];
      return `${address.diaChi}, ${address.phuongXa}, ${address.quanHuyen}, ${address.tinhThanh}`;
    }
    return customer.dia_chi || customer.address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ';
  }

  getAddressCount(): number {
    if (this.selectedCustomer && (this.selectedCustomer as any).diaChiList) {
      return (this.selectedCustomer as any).diaChiList.length;
    }
    return 0;
  }

  getAddressList(): any[] {
    if (this.selectedCustomer && (this.selectedCustomer as any).diaChiList) {
      return (this.selectedCustomer as any).diaChiList;
    }
    return [];
  }

  editCustomer(customer: Customer): void {
    console.log('üîß Edit customer clicked:', customer);
    this.selectedCustomer = customer;
    this.editingCustomer = customer;
    this.showAddModal = true;
    console.log('üîß showAddModal set to:', this.showAddModal);
    this.resetForm();
    
    // Populate form with customer data from backend structure
    this.customerForm.ho_ten = customer.ho_ten || customer.name || '';
    this.customerForm.so_dien_thoai = customer.so_dien_thoai || customer.phone || '';
    this.customerForm.email = customer.email || '';
    // ∆Øu ti√™n ngaySinh t·ª´ backend tr∆∞·ªõc, sau ƒë√≥ m·ªõi ƒë·∫øn ngay_sinh
    if ((customer as any).ngaySinh) {
      const date = new Date((customer as any).ngaySinh);
      (this.customerForm as any).ngay_sinh = date.toISOString().split('T')[0]; // Format YYYY-MM-DD for input type="date"
    } else if (customer.ngay_sinh) {
      const date = new Date(customer.ngay_sinh);
      (this.customerForm as any).ngay_sinh = date.toISOString().split('T')[0]; // Format YYYY-MM-DD for input type="date"
    } else {
      (this.customerForm as any).ngay_sinh = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD for input type="date"
    }
    this.customerForm.gioi_tinh = customer.gioi_tinh || false;
    this.customerForm.address = this.getCustomerAddress(customer);
    console.log('üîß Form populated:', this.customerForm);
    console.log('üîß Customer ngaySinh:', (customer as any).ngaySinh);
    console.log('üîß Customer ngay_sinh:', customer.ngay_sinh);
    console.log('üîß Form ngay_sinh:', this.customerForm.ngay_sinh);
    console.log('üîß Form ngay_sinh type:', typeof this.customerForm.ngay_sinh);
    console.log('üîß Form ngay_sinh value:', this.customerForm.ngay_sinh?.toISOString());
  }

  deleteCustomer(customer: Customer): void {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng "${customer.ho_ten || customer.name}"?`)) {
      // X√≥a ngay l·∫≠p t·ª©c kh·ªèi danh s√°ch local
      this.deleteCustomerFromLocal(customer);
      console.log('‚úÖ ƒê√£ x√≥a kh√°ch h√†ng!');
      
      // G·ªçi API backend ng·∫ßm (kh√¥ng ch·ªù response)
      this.customerService.deleteCustomer(customer.id || 0).subscribe({
        next: (response) => {
          console.log('‚úÖ X√≥a kh√°ch h√†ng th√†nh c√¥ng t·ª´ database:', response);
        },
        error: (error) => {
          console.error('‚ùå L·ªói khi x√≥a kh√°ch h√†ng t·ª´ database:', error);
          // Kh√¥ng hi·ªÉn th·ªã l·ªói cho user v√¨ ƒë√£ x√≥a th√†nh c√¥ng kh·ªèi local
        }
      });
    }
  }




  saveCustomerOffline(customerData: Customer): void {
    if (this.showEditModal && this.selectedCustomer) {
      // Update existing customer in local array
      const index = this.customers.findIndex(c => c.id === this.selectedCustomer!.id);
      if (index > -1) {
        this.customers[index] = customerData;
      }
      console.log('‚ö†Ô∏è ƒê√£ c·∫≠p nh·∫≠t kh√°ch h√†ng (offline mode)');
    } else {
      // Add new customer to local array
      customerData.id = Date.now(); // Generate temporary ID
      this.customers.push(customerData);
      console.log('‚ö†Ô∏è ƒê√£ th√™m kh√°ch h√†ng (offline mode)');
    }
    
    this.saveToLocalStorage();
    this.applyFilters();
    this.closeModals();
    this.resetForm();
    this.isLoading = false;
  }

  // Validation Methods
  validateCustomerForm(): boolean {
    this.customerFormErrors = {};
    let isValid = true;

    // Ki·ªÉm tra th√¥ng tin b·∫Øt bu·ªôc
    if (!this.customerForm.ho_ten) {
      this.customerFormErrors.ho_ten = 'T√™n kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
      isValid = false;
    } else if (this.customerForm.ho_ten.trim().length < 2) {
      this.customerFormErrors.ho_ten = 'T√™n kh√°ch h√†ng ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±';
      isValid = false;
    } else if (this.customerForm.ho_ten.trim().length > 100) {
      this.customerFormErrors.ho_ten = 'T√™n kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c qu√° 100 k√Ω t·ª±';
      isValid = false;
    }

    if (!this.customerForm.email) {
      this.customerFormErrors.email = 'Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
      isValid = false;
    } else {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(this.customerForm.email)) {
        this.customerFormErrors.email = 'Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng';
        isValid = false;
      } else {
        // Ki·ªÉm tra email tr√πng l·∫∑p
        const existingCustomer = this.customers.find(c => 
          c.email.toLowerCase() === this.customerForm.email.toLowerCase() && 
          (!this.showEditModal || c.id !== this.selectedCustomer?.id)
        );
        if (existingCustomer) {
          this.customerFormErrors.email = 'Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng';
          isValid = false;
        }
      }
    }

    if (!this.customerForm.so_dien_thoai) {
      this.customerFormErrors.so_dien_thoai = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
      isValid = false;
    } else {
      const phoneRegex = /^(\+84|84|0)[1-9][0-9]{8,9}$/;
      const cleanPhone = this.customerForm.so_dien_thoai.replace(/\s/g, '');
      if (!phoneRegex.test(cleanPhone)) {
        this.customerFormErrors.so_dien_thoai = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng';
        isValid = false;
      } else {
        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i tr√πng l·∫∑p
        const existingPhone = this.customers.find(c => 
          c.so_dien_thoai === cleanPhone && 
          (!this.showEditModal || c.id !== this.selectedCustomer?.id)
        );
        if (existingPhone) {
          this.customerFormErrors.so_dien_thoai = 'S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng';
          isValid = false;
        }
      }
    }

    // Validation date of birth
    if (this.customerForm.ngay_sinh) {
      const today = new Date();
      const birthDate = new Date(this.customerForm.ngay_sinh);
      const age = today.getFullYear() - birthDate.getFullYear();
      
      if (age < 0 || age > 120) {
        this.customerFormErrors.ngay_sinh = 'Tu·ªïi ph·∫£i t·ª´ 0-120 tu·ªïi';
        isValid = false;
      } else if (birthDate > today) {
        this.customerFormErrors.ngay_sinh = 'Ng√†y sinh kh√¥ng th·ªÉ l√† ng√†y trong t∆∞∆°ng lai';
        isValid = false;
      }
    }

    return isValid;
  }

  validateAddresses(): boolean {
    // Ki·ªÉm tra c√≥ √≠t nh·∫•t 1 ƒë·ªãa ch·ªâ
    if (this.addresses.length === 0) {
      console.log('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 ƒë·ªãa ch·ªâ cho kh√°ch h√†ng!');
      return false;
    }

    // Validation t·ª´ng ƒë·ªãa ch·ªâ
    for (let i = 0; i < this.addresses.length; i++) {
      const address = this.addresses[i];
      
      // Ki·ªÉm tra th√¥ng tin b·∫Øt bu·ªôc
      if (!address.specificAddress || !address.ward || !address.district || !address.province) {
        console.log(`‚ùå ƒê·ªãa ch·ªâ ${i + 1}: Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!\n- ƒê·ªãa ch·ªâ c·ª• th·ªÉ\n- Ph∆∞·ªùng/X√£\n- Qu·∫≠n/Huy·ªán\n- T·ªânh/Th√†nh ph·ªë`);
        return false;
      }

      // Ki·ªÉm tra ƒë·ªô d√†i ƒë·ªãa ch·ªâ c·ª• th·ªÉ
      if (address.specificAddress.trim().length < 10) {
        console.log(`‚ùå ƒê·ªãa ch·ªâ ${i + 1}: ƒê·ªãa ch·ªâ c·ª• th·ªÉ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±!`);
        return false;
      }

      if (address.specificAddress.trim().length > 200) {
        console.log(`‚ùå ƒê·ªãa ch·ªâ ${i + 1}: ƒê·ªãa ch·ªâ c·ª• th·ªÉ kh√¥ng ƒë∆∞·ª£c qu√° 200 k√Ω t·ª±!`);
        return false;
      }

      // Ki·ªÉm tra c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
      if (i === this.addresses.length - 1 && !address.isDefault) {
        console.log('‚ùå Ph·∫£i c√≥ √≠t nh·∫•t 1 ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh!');
        return false;
      }
    }

    return true;
  }

  validateAddressForm(): boolean {
    console.log('üîç Validating address form...');
    console.log('üìã Form data:', this.addressForm);
    
    // Ki·ªÉm tra th√¥ng tin b·∫Øt bu·ªôc - ch·ªâ c·∫ßn ƒë·ªãa ch·ªâ c·ª• th·ªÉ
    if (!this.addressForm.specificAddress || this.addressForm.specificAddress.trim() === '') {
      console.log('‚ùå ƒê·ªãa ch·ªâ c·ª• th·ªÉ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
      return false;
    }

    // Ki·ªÉm tra ƒë·ªô d√†i ƒë·ªãa ch·ªâ c·ª• th·ªÉ - gi·∫£m y√™u c·∫ßu
    if (this.addressForm.specificAddress.trim().length < 5) {
      console.log('‚ùå ƒê·ªãa ch·ªâ c·ª• th·ªÉ ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±!');
      return false;
    }

    if (this.addressForm.specificAddress.trim().length > 200) {
      console.log('‚ùå ƒê·ªãa ch·ªâ c·ª• th·ªÉ kh√¥ng ƒë∆∞·ª£c qu√° 200 k√Ω t·ª±!');
      return false;
    }

    // C√°c tr∆∞·ªùng kh√°c kh√¥ng b·∫Øt bu·ªôc - c√≥ th·ªÉ ƒë·ªÉ tr·ªëng
    console.log('‚úÖ Address validation passed');
    return true;
  }

  private deleteCustomerFromLocal(customer: Customer): void {
    // X√≥a kh·ªèi danh s√°ch local
    this.customers = this.customers.filter(c => c.id !== customer.id);
    this.saveToLocalStorage();
    this.applyFilters(); // √Åp d·ª•ng l·∫°i filter
  }

  // Helper methods for date filtering
  private isSameDay(date1: Date, date2: Date): boolean {
    return date1.getDate() === date2.getDate() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
  }

  private isSameWeek(date1: Date, date2: Date): boolean {
    const week1 = this.getWeekNumber(date1);
    const week2 = this.getWeekNumber(date2);
    return week1 === week2 && date1.getFullYear() === date2.getFullYear();
  }

  private isSameMonth(date1: Date, date2: Date): boolean {
    return date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
  }

  private getWeekNumber(date: Date): number {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
  }

  // Format currency for display
  formatCurrency(amount: number): string {
    return new Intl.NumberFormat('vi-VN').format(amount);
  }

  // Helper method to check if customer is toggling
  isCustomerToggling(customer: Customer): boolean {
    return (customer as any).isToggling || false;
  }

  // Toggle customer status
  toggleCustomerStatus(customer: Customer) {
    console.log('üîÑ Toggling customer status:', customer);
    
    // Toggle status immediately
    const newStatus = !customer.trang_thai;
    customer.trang_thai = newStatus;
    
    // Update local data immediately
    const index = this.customers.findIndex(c => c.id === customer.id);
    if (index !== -1) {
      this.customers[index].trang_thai = newStatus;
      this.saveToLocalStorage();
      this.applyFilters();
    }
    
    // Show success message
    const statusText = newStatus ? 'k√≠ch ho·∫°t' : 'h·ªßy k√≠ch ho·∫°t';
    console.log(`‚úÖ ƒê√£ ${statusText} kh√°ch h√†ng ${customer.ho_ten || customer.name}`);
    
    // Try to update backend in background (optional)
    try {
      this.customerService.updateCustomerStatus(customer.id || 0, newStatus).subscribe({
        next: (updatedCustomer) => {
          console.log('‚úÖ Backend sync completed:', updatedCustomer);
        },
        error: (error) => {
          console.error('‚ùå Backend sync failed:', error);
          console.log('‚ö†Ô∏è Local change is kept');
        }
      });
    } catch (error) {
      console.error('‚ùå Service call failed:', error);
    }
  }

}